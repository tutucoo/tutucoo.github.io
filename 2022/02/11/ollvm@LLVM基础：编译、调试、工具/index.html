<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>ollvm@LLVM基础：编译、调试、工具 - 打渔为生</title>
  <link rel="icon" href="https://i.imgur.com/SrZt9VU.jpg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=>
  
    <meta name="description" content="全平台漏洞挖掘手记">
  
  
  
    <link rel="alternate" href="/atom.xml " title="打渔为生" type="application/atom+xml">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.3.0"></head>

  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">打渔为生</a>
    <div class="subtitle">tutucoo的技术笔记</div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">主页</a>
        </li>
      
        <li class="menu-item">
          <a href="/atom.xml" class="menu-item-link">RSS</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">关于</a>
        </li>
      
    </ul>
  </nav>
</header>

<article class="post">
  <div class="post-title">
    <h1 class="article-title">ollvm@LLVM基础：编译、调试、工具</h1>
  </div>

  <!-- 文章目录 -->
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#LLVM%E5%9F%BA%E7%A1%80%EF%BC%9A%E7%BC%96%E8%AF%91%E3%80%81%E8%B0%83%E8%AF%95%E3%80%81%E5%B7%A5%E5%85%B7"><span class="toc-text">LLVM基础：编译、调试、工具</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#LLVM%E7%AE%80%E4%BB%8B"><span class="toc-text">LLVM简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#llvm%E4%B8%8B%E8%BD%BD"><span class="toc-text">llvm下载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#llvm%E7%BC%96%E8%AF%91"><span class="toc-text">llvm编译</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91debug%E7%89%88%E6%9C%AC"><span class="toc-text">编译debug版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91release%E7%89%88%E6%9C%AC"><span class="toc-text">编译release版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8CLion%E8%BF%9B%E8%A1%8C%E7%BC%96%E8%AF%91"><span class="toc-text">使用CLion进行编译</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E7%BC%96%E8%AF%91%E7%9A%84Clang%E7%A8%8B%E5%BA%8F"><span class="toc-text">测试编译的Clang程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E7%BC%96%E8%AF%91%E7%9A%84Clang%E7%A8%8B%E5%BA%8F"><span class="toc-text">调试编译的Clang程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E8%AF%95opt%E7%A8%8B%E5%BA%8F"><span class="toc-text">调试opt程序</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#llvm%E5%B7%A5%E5%85%B7"><span class="toc-text">llvm工具</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%96%E8%AF%91%E4%B8%AD%E9%97%B4%E8%AF%AD%E8%A8%80"><span class="toc-text">编译中间语言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#llvm-as%E5%B7%A5%E5%85%B7"><span class="toc-text">llvm-as工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#llc%E5%B7%A5%E5%85%B7"><span class="toc-text">llc工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#llvm-dis%E5%B7%A5%E5%85%B7"><span class="toc-text">llvm-dis工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#opt%E5%B7%A5%E5%85%B7"><span class="toc-text">opt工具</span></a></li></ol></li></ol></li></ol>

  <div class="post-content">
    <h1 id="LLVM基础：编译、调试、工具"><a href="#LLVM基础：编译、调试、工具" class="headerlink" title="LLVM基础：编译、调试、工具"></a>LLVM基础：编译、调试、工具</h1><h2 id="LLVM简介"><a href="#LLVM简介" class="headerlink" title="LLVM简介"></a>LLVM简介</h2><p>LLVM包含了很多项目 </p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211AkfVtX.png" alt="Untitled"></p>
<h2 id="llvm下载"><a href="#llvm下载" class="headerlink" title="llvm下载"></a>llvm下载</h2><p>ndk的llvm/bin目录下，有llvm套件，可以查看这些工具的版本，然后在llvm官网下载相近的版本就可以了</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./clang --version</span><br></pre></td></tr></table></figure>
<p>llvm源码目录</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/202202117mMtGq.png" alt="Untitled"></p>
<h2 id="llvm编译"><a href="#llvm编译" class="headerlink" title="llvm编译"></a>llvm编译</h2><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p>进入llvm.org/docs找到llvm文档，按照文档中环境要求进行安装和配置</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211GIDrhI.png" alt="Untitled"></p>
<p>有个方便的做法是把安卓源码依赖的程序全部安装上，这样基本就满足了llvm编译的环境要求了 </p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211M7Syja.png" alt="Untitled"></p>
<h3 id="编译debug版本"><a href="#编译debug版本" class="headerlink" title="编译debug版本"></a>编译debug版本</h3><p>进入llvm根目录创建build_debug目录并进入该目录，执行下面的命令</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211mgCSNc.png" alt="Untitled"></p>
<p>然后再执行ninja -j8命令</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211Q8e6Tn.png" alt="Untitled"></p>
<h3 id="编译release版本"><a href="#编译release版本" class="headerlink" title="编译release版本"></a>编译release版本</h3><p>在根目录下创建build_release目录并进入这个目录下，执行下面的命令</p>
<p>-DLLVM_ENABLE_PROJECTS=”clang”的意思添加编译clang程序，这样生成的bin目录下就有clang的可执行程序了</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211b015uU.png" alt="Untitled"></p>
<h3 id="使用CLion进行编译"><a href="#使用CLion进行编译" class="headerlink" title="使用CLion进行编译"></a>使用CLion进行编译</h3><p>打开项目，路径选择根目录llvm目录下的CMakeLists.txt文件 </p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211yros28.png" alt="Untitled"></p>
<p>进入设置，指定编译选项</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211JMuA3C.png" alt="Untitled"></p>
<p>点击确定之后项目会自动进行build</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211uKw8bl.png" alt="Untitled"></p>
<p>关闭CLion，进入命令行执行ninja -j8进行编译 </p>
<p>可以给CLion增加内存</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211QlkRNp.png" alt="Untitled"></p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211wC6Esy.png" alt="Untitled"></p>
<p>也可以进入cmake-build-debug目录单独编译某一个项目，比如说clang</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211yHWUtS.png" alt="Untitled"></p>
<h2 id="测试编译的Clang程序"><a href="#测试编译的Clang程序" class="headerlink" title="测试编译的Clang程序"></a>测试编译的Clang程序</h2><p>写一个简单的C文件</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211sBvRcw.png" alt="Untitled"></p>
<p>控制台添加刚编译的clang程序的环境变量</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> PATH=<span class="regexp">/home/</span>ollvm/llvm-project-<span class="number">9.0</span><span class="number">.1</span>/llvm/cmake-build-debug/bin:$PATH</span><br></pre></td></tr></table></figure>
<p>使用clang对C文件进行编译并运行 </p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">clang hello_clang.c -o hello_clang</span><br><span class="line">./hello_clang</span><br></pre></td></tr></table></figure>
<h2 id="调试编译的Clang程序"><a href="#调试编译的Clang程序" class="headerlink" title="调试编译的Clang程序"></a>调试编译的Clang程序</h2><p>找到clang程序  </p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211hD618k.png" alt="Untitled"></p>
<p>设置路径为刚才编辑的c文件</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211b85gdL.png" alt="Untitled"></p>
<p>点击确定后，目录下生成了一个可执行文件hello_clang_clion</p>
<p>然后找到clang目录下的tools里面的driver.cpp</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211lWnJdN.png" alt="Untitled"></p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211gEg0ov.png" alt="Untitled"></p>
<p>在main函数下断点就可以对clang进行调试了 </p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/202202113lBfwn.png" alt="Untitled"></p>
<h2 id="调试opt程序"><a href="#调试opt程序" class="headerlink" title="调试opt程序"></a>调试opt程序</h2><p>找到opt，然后进入配置</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211sf5Tbi.png" alt="Untitled"></p>
<p>把下图的参数填入Program arguments中</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211Xvz3xM.png" alt="Untitled"></p>
<p>hello_clang.dll文件路径需要修改为绝对路径，如果程序无法运行，可以把so文件路径的单引号去掉试试</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211ze7uCf.png" alt="Untitled"></p>
<p>opt工具在tools文件夹下</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211sD4R2X.png" alt="Untitled"></p>
<p>然后在main函数中下断，之后就可以进行调试了</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211T9Af1l.png" alt="Untitled"></p>
<p>中间文件的源文件也可以下断点进行调试</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211J7A1z7.png" alt="Untitled"></p>
<h2 id="llvm工具"><a href="#llvm工具" class="headerlink" title="llvm工具"></a>llvm工具</h2><h3 id="编译中间语言"><a href="#编译中间语言" class="headerlink" title="编译中间语言"></a>编译中间语言</h3><p>编译成中间语言，中间语言可以转为不同平台的汇编语言</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clang -emit-llvm -S hello_clang.c -o hello_clang.ll</span><br></pre></td></tr></table></figure>
<p>生成的ll文件</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20220211Lri4fu.png" alt="Untitled"></p>
<p>中间语言文件一样可以被执行</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lli hello_clang.ll</span><br></pre></td></tr></table></figure>
<h3 id="llvm-as工具"><a href="#llvm-as工具" class="headerlink" title="llvm-as工具"></a>llvm-as工具</h3><p>转为汇编之前要先转为bitcode文件，通过llvm-as工具完成</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">llvm-<span class="keyword">as</span> hello_clang.ll -o hello_clang.bc</span><br></pre></td></tr></table></figure>
<h3 id="llc工具"><a href="#llc工具" class="headerlink" title="llc工具"></a>llc工具</h3><p>通过llc工具把bitcode文件转为汇编文件</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">llc hello_clang.bc -o hello_clang.s</span><br></pre></td></tr></table></figure>
<h3 id="llvm-dis工具"><a href="#llvm-dis工具" class="headerlink" title="llvm-dis工具"></a>llvm-dis工具</h3><p>通过llvm-dis工具将bitcode文件转为中间文件</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">llvm-dis hello_clang.bc -o hello_clang_re.ll</span><br></pre></td></tr></table></figure>
<h3 id="opt工具"><a href="#opt工具" class="headerlink" title="opt工具"></a>opt工具</h3><p>opt工具主要的作用有两个：</p>
<ul>
<li>查看bitcode文件</li>
<li>对bc文件或ll文件执行pass</li>
</ul>

  </div>
  <div class="post-meta">
    <span class="post-time" style="color:#646060;font-size:13px">2022-02-11</span>
  </div>

  <div class="post-footer">
    

    <a href="#top" class="top">返回顶部</a>
  </div>
</article>

<!-- 评论插件 -->

<footer>
  2022
  <span class="author">
    tutucoo
  </span>
</footer>


    </div>
  </body>
</html>