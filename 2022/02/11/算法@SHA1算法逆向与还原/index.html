<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>算法@SHA1算法逆向与还原 - 打渔为生</title>
  <link rel="icon" href="https://i.imgur.com/SrZt9VU.jpg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=>
  
    <meta name="description" content="全平台漏洞挖掘手记">
  
  
  
    <link rel="alternate" href="/atom.xml " title="打渔为生" type="application/atom+xml">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.3.0"></head>

  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">打渔为生</a>
    <div class="subtitle">tutucoo的技术笔记</div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">主页</a>
        </li>
      
        <li class="menu-item">
          <a href="/atom.xml" class="menu-item-link">RSS</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">关于</a>
        </li>
      
    </ul>
  </nav>
</header>

<article class="post">
  <div class="post-title">
    <h1 class="article-title">算法@SHA1算法逆向与还原</h1>
  </div>

  <!-- 文章目录 -->
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SHA1%E7%AE%97%E6%B3%95%E9%80%86%E5%90%91%E4%B8%8E%E8%BF%98%E5%8E%9F"><span class="toc-text">SHA1算法逆向与还原</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E8%88%ACsha1%E7%AE%97%E6%B3%95%E8%BF%98%E5%8E%9F"><span class="toc-text">一般sha1算法还原</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SHA1Init%E5%B8%B8%E9%87%8F%E5%8F%98%E5%BD%A2%E8%BF%98%E5%8E%9F"><span class="toc-text">SHA1Init常量变形还原</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SHA1Transform%E5%8F%98%E5%BD%A2%E8%BF%98%E5%8E%9F"><span class="toc-text">SHA1Transform变形还原</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SHA1Update%E5%AD%97%E7%AC%A6%E4%B8%B2OLLVM%E6%B7%B7%E6%B7%86"><span class="toc-text">SHA1Update字符串OLLVM混淆</span></a></li></ol></li></ol>

  <div class="post-content">
    <h1 id="SHA1算法逆向与还原"><a href="#SHA1算法逆向与还原" class="headerlink" title="SHA1算法逆向与还原"></a>SHA1算法逆向与还原</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>sha1算法加密后的字符串长度是40位，sha256长度是64位</p>
<h2 id="一般sha1算法还原"><a href="#一般sha1算法还原" class="headerlink" title="一般sha1算法还原"></a>一般sha1算法还原</h2><p>目标程序加密结果跟SHA1算法对不上</p>
<p><img src="https://s2.loli.net/2022/02/11/Lg8UjlFRhq2X4GE.png" alt="Untitled"></p>
<p><img src="https://s2.loli.net/2022/02/11/mMAb8kfg1hQFePI.png" alt="Untitled"></p>
<p>看下伪代码，SHA1算法跟MD5是类似的，也会用调用SHA1Update函数  </p>
<p><img src="https://s2.loli.net/2022/02/11/GOk1WbZ6itMNxhm.png" alt="Untitled"></p>
<p>把盐字符串拼接上就对了</p>
<p><img src="https://s2.loli.net/2022/02/11/MlmW4afo79H2Jp3.png" alt="Untitled"></p>
<h2 id="SHA1Init常量变形还原"><a href="#SHA1Init常量变形还原" class="headerlink" title="SHA1Init常量变形还原"></a>SHA1Init常量变形还原</h2><p>运行目标程序，发现加密跟标准sha1对不上</p>
<p><img src="https://s2.loli.net/2022/02/11/7SdH6eTbUVpD2Er.png" alt="Untitled"></p>
<p><img src="https://s2.loli.net/2022/02/11/PBh4l57VRfKEISz.png" alt="Untitled"></p>
<p>看下伪代码，发现SHA1Init函数中的常量跟标准SHA1算法不一样了，把标准SHA1算法代码中的常量替换成目标程序中的SHA1常量进行还原</p>
<p><img src="https://s2.loli.net/2022/02/11/usIrEDJkvlQHoCp.png" alt="Untitled"></p>
<p><img src="https://s2.loli.net/2022/02/11/OrZhUpVjyRD2lGw.png" alt="Untitled"></p>
<p>把开源的sha1源码拷贝到Clion，把常量修改一下进行调用就可以实现算法还原工具了</p>
<p><img src="https://s2.loli.net/2022/02/11/beXuR6lZ95afTY3.png" alt="Untitled"></p>
<p><img src="https://s2.loli.net/2022/02/11/ZnMyHhiwK3AFatk.png" alt="Untitled"></p>
<h2 id="SHA1Transform变形还原"><a href="#SHA1Transform变形还原" class="headerlink" title="SHA1Transform变形还原"></a>SHA1Transform变形还原</h2><p>逆向SHA1Init里的常量保存一致，SHA1Update的盐字符串也一致，结果却不一样，可以考虑是SHA1Transform函数的常量值被替换了</p>
<p>SHA1Transform是SHA1Update函数内部的一个函数，里面有很多常量参与运算，找出所有的常量再在标准算法里比对（也可以通过脚本进行筛查）</p>
<p>SHA1算法里的k1-k4就是transform里面的几个常量</p>
<p><img src="https://s2.loli.net/2022/02/11/fxPoqDUZE8dSls6.png" alt="Untitled"></p>
<p>如果有不一致的地方修改回来，再编写算法还原工具</p>
<h2 id="SHA1Update字符串OLLVM混淆"><a href="#SHA1Update字符串OLLVM混淆" class="headerlink" title="SHA1Update字符串OLLVM混淆"></a>SHA1Update字符串OLLVM混淆</h2><p>可以看到这里字符串变成一个变量了</p>
<p><img src="https://s2.loli.net/2022/02/11/t5gJAh38wxTWC9N.png" alt="Untitled"></p>
<p>查看这几个变量的交叉引用会跟踪到非常复杂的混淆</p>
<p><img src="https://s2.loli.net/2022/02/11/GxM2ZbIzWTUlK5X.png" alt="Untitled"></p>
<p>对于这种情况可以通过frida hook这个变量地址直接打印出字符串再代入到算法工具中进行算法还原</p>
<p><img src="SHA1%E7%AE%97%E6%B3%95%E9%80%86%E5%90%91%E4%B8%8E%E8%BF%98%E5%8E%9F%20318b528f70494ee78f6f5c4b63619467/Untitled%2013.png" alt="Untitled"></p>

  </div>
  <div class="post-meta">
    <span class="post-time" style="color:#646060;font-size:13px">2022-02-11</span>
  </div>

  <div class="post-footer">
    

    <a href="#top" class="top">返回顶部</a>
  </div>
</article>

<!-- 评论插件 -->

<footer>
  2022
  <span class="author">
    tutucoo
  </span>
</footer>


    </div>
  </body>
</html>