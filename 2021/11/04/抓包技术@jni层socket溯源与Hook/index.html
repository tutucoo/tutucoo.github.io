<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>抓包技术@jni层socket溯源与Hook - 打渔为生</title>
  <link rel="icon" href="https://i.imgur.com/SrZt9VU.jpg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=>
  
    <meta name="description" content="全平台漏洞挖掘手记">
  
  
  
    <link rel="alternate" href="/atom.xml " title="打渔为生" type="application/atom+xml">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.3.0"></head>

  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">打渔为生</a>
    <div class="subtitle">tutucoo的技术笔记</div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">主页</a>
        </li>
      
        <li class="menu-item">
          <a href="/summary" class="menu-item-link">Summary</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">关于</a>
        </li>
      
        <li class="menu-item">
          <a href="/atom.xml" class="menu-item-link">RSS</a>
        </li>
      
    </ul>
  </nav>
</header>

<article class="post">
  <div class="post-title">
    <h1 class="article-title">抓包技术@jni层socket溯源与Hook</h1>
  </div>

  <!-- 文章目录 -->
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#jni-socket%E6%BA%AF%E6%BA%90"><span class="toc-text">jni socket溯源</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#hook-jni%E5%B1%82tcp-socket%E6%8E%A5%E5%8F%A3"><span class="toc-text">hook jni层tcp socket接口</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#hook-jni%E5%B1%82udp-socket%E6%8E%A5%E5%8F%A3"><span class="toc-text">hook jni层udp socket接口</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95native-socket%E4%BB%A3%E7%A0%81"><span class="toc-text">测试native socket代码</span></a></li></ol>

  <div class="post-content">
    <h1 id="jni-socket溯源"><a href="#jni-socket溯源" class="headerlink" title="jni socket溯源"></a>jni socket溯源</h1><p>java层socket请求最后调用的api是socketRead0和socketWrite0</p>
<p>在Android8.0源码中搜索socketRead0，找到所在的c文件，Android会通过编译c文件生成一个so文件</p>
<p><img src="https://i.loli.net/2021/11/04/TvgZuIUOFmQKbCA.png" alt="Untitled"></p>
<p>通过这个函数的函数名看出它是一个动态注册的函数，因此找到so文件以后要通过JNI_OnLoad函数找到注册函数的位置</p>
<p><img src="https://i.loli.net/2021/11/04/qlk5aNvuTeZsgzA.png" alt="Untitled"></p>
<p>SocketInputStream.c所在的文件夹是/libcore/ojluni，在该文件夹下通过搜索找到它，可以看到同时找到了一个openjdksub.mk，该文件会对SocketOutputstream.c进行编译并生成so文件，不过打开openjdksub.mk并没有看到生成so文件的配置 </p>
<p><img src="https://i.loli.net/2021/11/04/iXJ5apvKQO1Sdh4.png" alt="jni%E5%B1%82socket%E6%BA%AF%E6%BA%90%E4%B8%8EHook%20d4893f5d804244cfaff2d74c07da4008/Untitled%202.png"></p>
<p>退到上一层目录，继续搜索openjdksub.mk，可以找到NativeCode.mk文件</p>
<p><img src="https://i.loli.net/2021/11/04/Sx1Znv64qQIsP8J.png" alt="Untitled"></p>
<p>可以看到编译的so文件名，那么最终SocketOutputStream.c会被编译到libopenjdk.so中，所以接下来用IDA逆向libopenjdk.so，就可以找到socketRead0动态注册的代码</p>
<p><img src="https://i.loli.net/2021/11/04/YoGqtCfHeQ2OdVy.png" alt="Untitled"></p>
<p>生成的so位于/system/lib/libopenjdk.so，通过adb pull可以获取到文件，拖入到IDA中进行分析</p>
<p>在JNI_OnLoad中找到SocketInputStream和SocketOutputStream注册的代码</p>
<p><img src="https://i.loli.net/2021/11/04/c4JeubdDPm9ZzkF.png" alt="Untitled"></p>
<p>进入SocketInputStream找到jniRegisterNativeMethods，这个函数是用来动态注册jni函数的，不过这里解析有点错误，没有看到它的参数</p>
<p><img src="https://i.loli.net/2021/11/04/TgFXdIwWm6zfSRJ.png" alt="Untitled"></p>
<p>这个函数一般的用法，可以看到除了JNIEnv*作为第一个参数，还有3个参数，分别是类名、函数数组、函数数量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">extern <span class="string">&quot;C&quot;</span> <span class="function"><span class="keyword">int</span> <span class="title">jniRegisterNativeMethods</span><span class="params">(C_JNIEnv* env, <span class="keyword">const</span> <span class="keyword">char</span>* className, <span class="keyword">const</span> JNINativeMethod* gMethods, <span class="keyword">int</span> numMethods)</span> </span>&#123;</span><br><span class="line">    JNIEnv* e = reinterpret_cast&lt;JNIEnv*&gt;(env);</span><br><span class="line">    <span class="function">scoped_local_ref&lt;jclass&gt; <span class="title">c</span><span class="params">(env, findClass(env, className)</span>)</span>;</span><br><span class="line">    <span class="keyword">if</span> (c.get() == NULL) &#123;</span><br><span class="line">        e-&gt;FatalError(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((*env)-&gt;RegisterNatives(e, c.get(), gMethods, numMethods) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        e-&gt;FatalError(<span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>按tab键查看反汇编 </p>
<p><img src="https://i.loli.net/2021/11/04/Qm5OfNWXjVGe9qi.png" alt="Untitled"></p>
<p>跳转到off_287c4可以看到是函数数组，这也证实了这个函数确实传递了参数</p>
<p><img src="https://i.loli.net/2021/11/04/KngmHfTh2euM7Zk.png" alt="Untitled"></p>
<p>进行还原参数</p>
<p><img src="https://i.loli.net/2021/11/04/knfO8lFNr6AbxBy.png" alt="Untitled"></p>
<p>搜索到socketWrite0函数，然后可以查看xrefs from，看到它接下来会调用j_NET_Send函数  </p>
<p><img src="https://i.loli.net/2021/11/04/aGVZPTwc5pKJdMv.png" alt="Untitled"></p>
<p>在socketWrite0中找到j_NET_Send函数进入，调用了NET_Send函数 </p>
<p><img src="https://i.loli.net/2021/11/04/ZMs3i6YwVxuAbjX.png" alt="Untitled"></p>
<p>然后是sendto函数  </p>
<p><img src="https://i.loli.net/2021/11/04/8Se4Zx5ycdObfo3.png" alt="Untitled"></p>
<p>可以看到sendto函数是导入的，它位于libc.so文件中，sendto内部调用了syscall，完成最终调用 </p>
<p><img src="https://i.loli.net/2021/11/04/oQPXy5RMAnreuzv.png" alt="Untitled"></p>
<h1 id="hook-jni层tcp-socket接口"><a href="#hook-jni层tcp-socket接口" class="headerlink" title="hook jni层tcp socket接口"></a>hook jni层tcp socket接口</h1><p>先搭建tcp通信环境，然后进行frida hook</p>
<p>hook脚本</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LogPrint</span>(<span class="params">log</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> theDate = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">    <span class="keyword">var</span> hour = theDate.getHours();</span><br><span class="line">    <span class="keyword">var</span> minute = theDate.getMinutes();</span><br><span class="line">    <span class="keyword">var</span> second = theDate.getSeconds();</span><br><span class="line">    <span class="keyword">var</span> mSecond = theDate.getMilliseconds();</span><br><span class="line"></span><br><span class="line">    hour &lt; <span class="number">10</span> ? hour = <span class="string">&quot;0&quot;</span> + hour : hour;</span><br><span class="line">    minute &lt; <span class="number">10</span> ? minute = <span class="string">&quot;0&quot;</span> + minute : minute;</span><br><span class="line">    second &lt; <span class="number">10</span> ? second = <span class="string">&quot;0&quot;</span> + second : second;</span><br><span class="line">    mSecond &lt; <span class="number">10</span> ? mSecond = <span class="string">&quot;00&quot;</span> + mSecond : mSecond &lt; <span class="number">100</span> ? mSecond = <span class="string">&quot;0&quot;</span> + mSecond : mSecond;</span><br><span class="line">    <span class="keyword">var</span> time = hour + <span class="string">&quot;:&quot;</span> + minute + <span class="string">&quot;:&quot;</span> + second + <span class="string">&quot;:&quot;</span> + mSecond;</span><br><span class="line">    <span class="keyword">var</span> threadid = Process.getCurrentThreadId();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[&quot;</span> + time + <span class="string">&quot;]&quot;</span> + <span class="string">&quot;-&gt;threadid:&quot;</span> + threadid + <span class="string">&quot;--&quot;</span> + log);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printNativeStack</span>(<span class="params">context, name</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//Debug.</span></span><br><span class="line">    <span class="keyword">var</span> array = Thread.backtrace(context, Backtracer.ACCURATE);</span><br><span class="line">    <span class="keyword">var</span> first = DebugSymbol.fromAddress(array[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">if</span> (first.toString().indexOf(<span class="string">&#x27;libopenjdk.so!NET_Send&#x27;</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> trace = Thread.backtrace(context, Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        LogPrint(<span class="string">&quot;-----------start:&quot;</span> + name + <span class="string">&quot;--------------&quot;</span>);</span><br><span class="line">        LogPrint(trace);</span><br><span class="line">        LogPrint(<span class="string">&quot;-----------end:&quot;</span> + name + <span class="string">&quot;--------------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printJavaStack</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> Exception = Java.use(<span class="string">&quot;java.lang.Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> ins = Exception.$new(<span class="string">&quot;Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> straces = ins.getStackTrace();</span><br><span class="line">        <span class="keyword">if</span> (straces != <span class="literal">undefined</span> &amp;&amp; straces != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> strace = straces.toString();</span><br><span class="line">            <span class="keyword">var</span> replaceStr = strace.replace(<span class="regexp">/,/g</span>, <span class="string">&quot; \n &quot;</span>);</span><br><span class="line">            LogPrint(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack strat=======================&quot;</span>);</span><br><span class="line">            LogPrint(replaceStr);</span><br><span class="line">            LogPrint(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack end======================= \n &quot;</span>);</span><br><span class="line">            Exception.$dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isprintable</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (value &gt;= <span class="number">32</span> &amp;&amp; value &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getsocketdetail</span>(<span class="params">fd</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> type = Socket.type(fd);</span><br><span class="line">    <span class="keyword">if</span> (type != <span class="literal">null</span>) &#123;</span><br><span class="line">        result = result + <span class="string">&quot;type:&quot;</span> + type;</span><br><span class="line">        <span class="keyword">var</span> peer = Socket.peerAddress(fd);</span><br><span class="line">        <span class="keyword">var</span> local = Socket.localAddress(fd);</span><br><span class="line">        result = result + <span class="string">&quot;,address:&quot;</span> + <span class="built_in">JSON</span>.stringify(peer) + <span class="string">&quot;,local:&quot;</span> + <span class="built_in">JSON</span>.stringify(local);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hooklibc</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> libcmodule = Process.getModuleByName(<span class="string">&quot;libc.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> recvfrom_addr = libcmodule.getExportByName(<span class="string">&quot;recvfrom&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> sendto_addr = libcmodule.getExportByName(<span class="string">&quot;sendto&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(recvfrom_addr + <span class="string">&quot;---&quot;</span> + sendto_addr);</span><br><span class="line">    <span class="comment">//ssize_t recvfrom(int fd, void *buf, size_t n, int flags, struct sockaddr *addr, socklen_t *addr_len)</span></span><br><span class="line">    Interceptor.attach(recvfrom_addr, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.arg0 = args[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg1 = args[<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg2 = args[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">            LogPrint(<span class="string">&quot;go into libc.so-&gt;recvfom&quot;</span>);</span><br><span class="line"></span><br><span class="line">            printNativeStack(<span class="built_in">this</span>.context, <span class="string">&quot;recvfom&quot;</span>);</span><br><span class="line">        &#125;, <span class="function"><span class="title">onLeave</span>(<span class="params">retval</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> size = retval.toInt32();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> result = getsocketdetail(<span class="built_in">this</span>.arg0.toInt32());</span><br><span class="line">                <span class="built_in">console</span>.log(result + <span class="string">&quot;---libc.so-&gt;recvfrom:&quot;</span> + hexdump(<span class="built_in">this</span>.arg1, &#123;</span><br><span class="line">                    length: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LogPrint(<span class="string">&quot;leave libc.so-&gt;recvfom&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//ssize_t sendto(int fd, const void *buf, size_t n, int flags, const struct sockaddr *addr, socklen_t addr_len)</span></span><br><span class="line">    Interceptor.attach(sendto_addr, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.arg0 = args[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg1 = args[<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg2 = args[<span class="number">2</span>];</span><br><span class="line">            LogPrint(<span class="string">&quot;go into libc.so-&gt;sendto&quot;</span>);</span><br><span class="line">            printNativeStack(<span class="built_in">this</span>.context, <span class="string">&quot;sendto&quot;</span>);</span><br><span class="line">        &#125;, <span class="function"><span class="title">onLeave</span>(<span class="params">retval</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> size = ptr(<span class="built_in">this</span>.arg2).toInt32();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> result = getsocketdetail(<span class="built_in">this</span>.arg0.toInt32());</span><br><span class="line">                <span class="built_in">console</span>.log(result + <span class="string">&quot;---libc.so-&gt;sendto:&quot;</span> + hexdump(<span class="built_in">this</span>.arg1, &#123;</span><br><span class="line">                    length: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LogPrint(<span class="string">&quot;leave libc.so-&gt;sendto&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    hooklibc();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2021/11/04/on9DlVCESTuxU1s.png" alt="Untitled"></p>
<h1 id="hook-jni层udp-socket接口"><a href="#hook-jni层udp-socket接口" class="headerlink" title="hook jni层udp socket接口"></a>hook jni层udp socket接口</h1><p>跟hook tcp会有些差别，因为在实际调试过程中，发现第一个参数套接字，已经无法从中得到ip和端口了，所以只能从第4个参数进行hook，取出来，发现是一个结构体，一个字节一个字节的读取出来，然后再本地计算，拼接，就ok了。</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LogPrint</span>(<span class="params">log</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> theDate = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">    <span class="keyword">var</span> hour = theDate.getHours();</span><br><span class="line">    <span class="keyword">var</span> minute = theDate.getMinutes();</span><br><span class="line">    <span class="keyword">var</span> second = theDate.getSeconds();</span><br><span class="line">    <span class="keyword">var</span> mSecond = theDate.getMilliseconds();</span><br><span class="line"></span><br><span class="line">    hour &lt; <span class="number">10</span> ? hour = <span class="string">&quot;0&quot;</span> + hour : hour;</span><br><span class="line">    minute &lt; <span class="number">10</span> ? minute = <span class="string">&quot;0&quot;</span> + minute : minute;</span><br><span class="line">    second &lt; <span class="number">10</span> ? second = <span class="string">&quot;0&quot;</span> + second : second;</span><br><span class="line">    mSecond &lt; <span class="number">10</span> ? mSecond = <span class="string">&quot;00&quot;</span> + mSecond : mSecond &lt; <span class="number">100</span> ? mSecond = <span class="string">&quot;0&quot;</span> + mSecond : mSecond;</span><br><span class="line">    <span class="keyword">var</span> time = hour + <span class="string">&quot;:&quot;</span> + minute + <span class="string">&quot;:&quot;</span> + second + <span class="string">&quot;:&quot;</span> + mSecond;</span><br><span class="line">    <span class="keyword">var</span> threadid = Process.getCurrentThreadId();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[&quot;</span> + time + <span class="string">&quot;]&quot;</span> + <span class="string">&quot;-&gt;threadid:&quot;</span> + threadid + <span class="string">&quot;--&quot;</span> + log);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printNativeStack</span>(<span class="params">context, name</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//frida自带接口</span></span><br><span class="line">    <span class="keyword">var</span> array = Thread.backtrace(context, Backtracer.ACCURATE);</span><br><span class="line">    <span class="keyword">var</span> first = DebugSymbol.fromAddress(array[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">if</span> (first.toString().indexOf(<span class="string">&#x27;libopenjdk.so!NET_Send&#x27;</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> trace = Thread.backtrace(context, Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        LogPrint(<span class="string">&quot;-----------start:&quot;</span> + name + <span class="string">&quot;--------------&quot;</span>);</span><br><span class="line">        LogPrint(trace);</span><br><span class="line">        LogPrint(<span class="string">&quot;-----------end:&quot;</span> + name + <span class="string">&quot;--------------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printJavaStack</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> Exception = Java.use(<span class="string">&quot;java.lang.Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> ins = Exception.$new(<span class="string">&quot;Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> straces = ins.getStackTrace();</span><br><span class="line">        <span class="keyword">if</span> (straces != <span class="literal">undefined</span> &amp;&amp; straces != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> strace = straces.toString();</span><br><span class="line">            <span class="keyword">var</span> replaceStr = strace.replace(<span class="regexp">/,/g</span>, <span class="string">&quot; \n &quot;</span>);</span><br><span class="line">            LogPrint(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack strat=======================&quot;</span>);</span><br><span class="line">            LogPrint(replaceStr);</span><br><span class="line">            LogPrint(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack end======================= \n &quot;</span>);</span><br><span class="line">            Exception.$dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isprintable</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (value &gt;= <span class="number">32</span> &amp;&amp; value &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getsocketdetail</span>(<span class="params">fd</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> type = Socket.type(fd);</span><br><span class="line">    <span class="keyword">if</span> (type != <span class="literal">null</span>) &#123;</span><br><span class="line">        result = result + <span class="string">&quot;type:&quot;</span> + type;</span><br><span class="line">        <span class="keyword">var</span> peer = Socket.peerAddress(fd);</span><br><span class="line">        <span class="keyword">var</span> local = Socket.localAddress(fd);</span><br><span class="line">        result = result + <span class="string">&quot;,address:&quot;</span> + <span class="built_in">JSON</span>.stringify(peer) + <span class="string">&quot;,local:&quot;</span> + <span class="built_in">JSON</span>.stringify(local);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getip</span>(<span class="params">ip_ptr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = ptr(ip_ptr).readU8() + <span class="string">&quot;.&quot;</span> + ptr(ip_ptr.add(<span class="number">1</span>)).readU8() + <span class="string">&quot;.&quot;</span> + ptr(ip_ptr.add(<span class="number">2</span>)).readU8() + <span class="string">&quot;.&quot;</span> + ptr(ip_ptr.add(<span class="number">3</span>)).readU8()</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getudpaddr</span>(<span class="params">addrptr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> port_ptr = addrptr.add(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">var</span> port = ptr(port_ptr).readU8() * <span class="number">256</span> + ptr(port_ptr.add(<span class="number">1</span>)).readU8();</span><br><span class="line">    <span class="keyword">var</span> ip_ptr = addrptr.add(<span class="number">4</span>);</span><br><span class="line">    <span class="keyword">var</span> ip_addr = getip(ip_ptr);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;peer:&quot;</span>+ip_addr+<span class="string">&quot;--port:&quot;</span>+port;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hooklibc</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> libcmodule = Process.getModuleByName(<span class="string">&quot;libc.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> recvfrom_addr = libcmodule.getExportByName(<span class="string">&quot;recvfrom&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> sendto_addr = libcmodule.getExportByName(<span class="string">&quot;sendto&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(recvfrom_addr + <span class="string">&quot;---&quot;</span> + sendto_addr);</span><br><span class="line">    <span class="comment">//ssize_t recvfrom(int fd, void *buf, size_t n, int flags, struct sockaddr *addr, socklen_t *addr_len)</span></span><br><span class="line">    Interceptor.attach(recvfrom_addr, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.arg0 = args[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg1 = args[<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg2 = args[<span class="number">2</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg3 = args[<span class="number">3</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg4 = args[<span class="number">4</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg5 = args[<span class="number">5</span>];</span><br><span class="line">            LogPrint(<span class="string">&quot;go into libc.so-&gt;recvfom&quot;</span>);</span><br><span class="line"></span><br><span class="line">            printNativeStack(<span class="built_in">this</span>.context, <span class="string">&quot;recvfom&quot;</span>);</span><br><span class="line">        &#125;, <span class="function"><span class="title">onLeave</span>(<span class="params">retval</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> size = retval.toInt32();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> result = getsocketdetail(<span class="built_in">this</span>.arg0.toInt32());</span><br><span class="line">                <span class="keyword">if</span> (result.indexOf(<span class="string">&#x27;udp&#x27;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">/*75struct sockaddr_in &#123;</span></span><br><span class="line"><span class="comment">                    76	short	sin_family;</span></span><br><span class="line"><span class="comment">                    77	u_short	sin_port;</span></span><br><span class="line"><span class="comment">                    78	struct in_addr	sin_addr;</span></span><br><span class="line"><span class="comment">                    79	char	sin_zero[8];</span></span><br><span class="line"><span class="comment">                    80&#125;;*/</span></span><br><span class="line">                    <span class="keyword">var</span> sockaddr_in_ptr = <span class="built_in">this</span>.arg4;</span><br><span class="line">                    <span class="keyword">var</span> sizeofsockaddr_in = <span class="built_in">this</span>.arg5;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//02 00 22 b8 c0 a8 05 96 00 00 00 00 00 00 00 00</span></span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;this is a recvfrom udp!-&gt;&quot;</span> + getudpaddr(sockaddr_in_ptr) + <span class="string">&quot;---&quot;</span> + sizeofsockaddr_in);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">console</span>.log(Process.getCurrentThreadId()+result + <span class="string">&quot;---libc.so-&gt;recvfrom:&quot;</span> + hexdump(<span class="built_in">this</span>.arg1, &#123;</span><br><span class="line">                    length: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LogPrint(<span class="string">&quot;leave libc.so-&gt;recvfom&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">//ssize_t sendto(int fd, const void *buf, size_t n, int flags, const struct sockaddr *addr, socklen_t addr_len)</span></span><br><span class="line">    Interceptor.attach(sendto_addr, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.arg0 = args[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg1 = args[<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg2 = args[<span class="number">2</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg3 = args[<span class="number">3</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg4 = args[<span class="number">4</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg5 = args[<span class="number">5</span>];</span><br><span class="line">            LogPrint(<span class="string">&quot;go into libc.so-&gt;sendto&quot;</span>);</span><br><span class="line">            printNativeStack(<span class="built_in">this</span>.context, <span class="string">&quot;sendto&quot;</span>);</span><br><span class="line">        &#125;, <span class="function"><span class="title">onLeave</span>(<span class="params">retval</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> size = ptr(<span class="built_in">this</span>.arg2).toInt32();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> result = getsocketdetail(<span class="built_in">this</span>.arg0.toInt32());</span><br><span class="line">                <span class="keyword">if</span> (result.indexOf(<span class="string">&#x27;udp&#x27;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">/*75struct sockaddr_in &#123;</span></span><br><span class="line"><span class="comment">                    76	short	sin_family;</span></span><br><span class="line"><span class="comment">                    77	u_short	sin_port;</span></span><br><span class="line"><span class="comment">                    78	struct in_addr	sin_addr;</span></span><br><span class="line"><span class="comment">                    79	char	sin_zero[8];</span></span><br><span class="line"><span class="comment">                    80&#125;;*/</span></span><br><span class="line">                    <span class="keyword">var</span> sockaddr_in_ptr = <span class="built_in">this</span>.arg4;</span><br><span class="line">                    <span class="keyword">var</span> sizeofsockaddr_in = <span class="built_in">this</span>.arg5;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//02 00 22 b8 c0 a8 05 96 00 00 00 00 00 00 00 00</span></span><br><span class="line">                    <span class="built_in">console</span>.log(<span class="string">&quot;this is a sendto udp!-&gt;&quot;</span> + getudpaddr(sockaddr_in_ptr) + <span class="string">&quot;---&quot;</span> + sizeofsockaddr_in);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="built_in">console</span>.log(Process.getCurrentThreadId()+<span class="string">&quot;---&quot;</span>+result + <span class="string">&quot;---libc.so-&gt;sendto:&quot;</span> + hexdump(<span class="built_in">this</span>.arg1, &#123;</span><br><span class="line">                    length: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LogPrint(<span class="string">&quot;leave libc.so-&gt;sendto&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    hooklibc();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2021/11/04/qIg7xHFDLiumoRw.png" alt="Untitled"></p>
<h1 id="测试native-socket代码"><a href="#测试native-socket代码" class="headerlink" title="测试native socket代码"></a>测试native socket代码</h1><p>在native层使用socket发送一个简单的http请求，再使用frida hook jni层的socket接口</p>
<p>httpget.h</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;fcntl.h&gt;</span><br><span class="line">#include &lt;ctype.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;netdb.h&gt;</span><br><span class="line">#include &lt;sys/types.h&gt;</span><br><span class="line">#include &lt;sys/stat.h&gt;</span><br><span class="line">#include &lt;sys/socket.h&gt;</span><br><span class="line">#include &lt;netinet/in.h&gt;</span><br><span class="line">#include &lt;arpa/inet.h&gt;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">GetHttpResponseHead</span><span class="params">(<span class="keyword">int</span> sock,<span class="keyword">char</span> *buf,<span class="keyword">int</span> size)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">HttpGet</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *server,<span class="keyword">const</span> <span class="keyword">char</span> *url)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">testhttp</span><span class="params">(<span class="keyword">void</span>)</span></span>;</span><br></pre></td></tr></table></figure>
<p>httpget.c</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;httpget.h&quot;</span><br><span class="line">#include &lt;android/log.h&gt;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">GetHttpResponseHead</span><span class="params">(<span class="keyword">int</span> sock, <span class="keyword">char</span> *buf, <span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="keyword">char</span> *code, *status;</span><br><span class="line">    memset(buf, <span class="number">0</span>, size);</span><br><span class="line">    <span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; size - <span class="number">1</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (recv(sock, buf + i, <span class="number">1</span>, <span class="number">0</span>) != <span class="number">1</span>) &#123;</span><br><span class="line">            perror(<span class="string">&quot;recv error&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (strstr(buf, <span class="string">&quot;\r\n\r\n&quot;</span>))</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= size - <span class="number">1</span>) &#123;</span><br><span class="line">        puts(<span class="string">&quot;Http response head too long.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    code = strstr(buf, <span class="string">&quot; 200 &quot;</span>);</span><br><span class="line">    status = strstr(buf, <span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!code || code &gt; status) &#123;</span><br><span class="line">        *status = <span class="number">0</span>;</span><br><span class="line">        printf(<span class="string">&quot;Bad http response:\&quot;%s\&quot;\n&quot;</span>, buf);</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">HttpGet</span><span class="params">(<span class="keyword">const</span> <span class="keyword">char</span> *server, <span class="keyword">const</span> <span class="keyword">char</span> *url)</span> </span>&#123;</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;-----from--jni-------&quot;</span>, <span class="string">&quot;Enter HttpGet function!&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> sock = socket(PF_INET, SOCK_STREAM, <span class="number">0</span>);</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;-----from--jni-------&quot;</span>, <span class="string">&quot;%d&quot;</span>, sock);</span><br><span class="line">    struct sockaddr_in peerAddr;</span><br><span class="line">    <span class="keyword">char</span> buf[<span class="number">2048</span>];</span><br><span class="line">    <span class="keyword">int</span> ret;</span><br><span class="line">    <span class="comment">//const char *filename;</span></span><br><span class="line">    <span class="comment">//FILE *fp=NULL;</span></span><br><span class="line">    peerAddr.sin_family = AF_INET;</span><br><span class="line">    peerAddr.sin_port = htons(<span class="number">5000</span>);</span><br><span class="line">    peerAddr.sin_addr.s_addr = inet_addr(<span class="string">&quot;192.168.5.150&quot;</span>);</span><br><span class="line">    ret = connect(sock, (struct sockaddr *) &amp;peerAddr, sizeof(peerAddr));</span><br><span class="line">    <span class="keyword">if</span> (ret != <span class="number">0</span>) &#123;</span><br><span class="line">        perror(<span class="string">&quot;connect failed&quot;</span>);</span><br><span class="line">        close(sock);</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sprintf(buf,</span><br><span class="line">            <span class="string">&quot;GET %s HTTP/1.1\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Accept: */*\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;User-Agent: FireFox\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Host: %s\r\n&quot;</span></span><br><span class="line">            <span class="string">&quot;Connection: Close\r\n\r\n&quot;</span>,</span><br><span class="line">            url, server);</span><br><span class="line">    send(sock, buf, strlen(buf), <span class="number">0</span>);</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;-----from--jni-------&quot;</span>, <span class="string">&quot;%s&quot;</span>, <span class="string">&quot;send over&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (GetHttpResponseHead(sock, buf, sizeof(buf)) &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        close(sock);</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;-----from--jni-------&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;Enter HttpGet function&#x27;s while!&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> ((ret = recv(sock, buf, sizeof(buf), <span class="number">0</span>)) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;-----from--jni-------&quot;</span>,</span><br><span class="line">                            <span class="string">&quot;hello, this is my number %s log message!&quot;</span>, buf);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//&#125;</span></span><br><span class="line">    <span class="comment">//fclose(fp);</span></span><br><span class="line">    shutdown(sock, SHUT_RDWR);</span><br><span class="line">    close(sock);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//&quot;http://192.168.7.222/index.html&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">testhttp</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">    __android_log_print(ANDROID_LOG_INFO, <span class="string">&quot;-----from--jni-------&quot;</span>, <span class="string">&quot;Enter mmain function!&quot;</span>);</span><br><span class="line">    <span class="keyword">char</span> *head, *tail;</span><br><span class="line">    <span class="keyword">char</span> server[<span class="number">128</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    head = strstr(<span class="string">&quot;http://192.168.1.141:5000/index.html&quot;</span>, <span class="string">&quot;//&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!head) &#123;</span><br><span class="line">        puts(<span class="string">&quot;Bad url format&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    head += <span class="number">2</span>;</span><br><span class="line">    tail = strchr(head, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span> (!tail) &#123;</span><br><span class="line">        <span class="keyword">return</span> HttpGet(head, <span class="string">&quot;/&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tail - head &gt; sizeof(server) - <span class="number">1</span>) &#123;</span><br><span class="line">        puts(<span class="string">&quot;Bad url format&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        memcpy(server, head, tail - head);</span><br><span class="line">        <span class="keyword">return</span> HttpGet(server, tail);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>创建一个线程发送http请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;jni.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">#include &lt;android/log.h&gt;</span><br><span class="line">#include &lt;sys/socket.h&gt;</span><br><span class="line">#include &lt;netinet/in.h&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;android/log.h&gt;</span><br><span class="line">#include &lt;unistd.h&gt;</span><br><span class="line">#include &lt;netdb.h&gt;</span><br><span class="line">#include &lt;pthread.h&gt;</span><br><span class="line"></span><br><span class="line">extern <span class="string">&quot;C&quot;</span> &#123;</span><br><span class="line">#include &quot;httpget.h&quot;</span><br><span class="line">&#125;</span><br><span class="line">#define  LOG_TAG    &quot;socket&quot;</span><br><span class="line"></span><br><span class="line">#define  LOGI(...)  __android_log_print(ANDROID_LOG_INFO,LOG_TAG,__VA_ARGS__)</span><br><span class="line">#define MAXSIZE 4096</span><br><span class="line">pthread_t pthread;<span class="comment">//线程对象</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> *threadDoThings(<span class="keyword">void</span> *data) &#123;</span><br><span class="line">    LOGI(<span class="string">&quot;jni thread do things&quot;</span>);</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">        pthread_t udppthread,tcpthread;<span class="comment">//线程对象</span></span><br><span class="line">        pthread_create(&amp;tcpthread, NULL, reinterpret_cast&lt;<span class="keyword">void</span> *(*)(<span class="keyword">void</span> *)&gt;(testhttp), NULL);</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//pthread_//exit(&amp;pthread);</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">extern <span class="string">&quot;C&quot;</span> JNIEXPORT jstring JNICALL</span><br><span class="line">Java_com_example_okhttp_MainActivity_stringFromJNI(</span><br><span class="line">        JNIEnv *env,</span><br><span class="line">        jobject <span class="comment">/* this */</span>) &#123;</span><br><span class="line">    <span class="comment">// TODO</span></span><br><span class="line">    LOGI(<span class="string">&quot;normal thread&quot;</span>);</span><br><span class="line">    <span class="comment">//创建线程</span></span><br><span class="line">    pthread_create(&amp;pthread, NULL, threadDoThings, NULL);</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">char</span> *hello = <span class="string">&quot;Hello from C++&quot;</span>;</span><br><span class="line">    <span class="keyword">return</span> env-&gt;NewStringUTF(hello);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AndroidManifest.xml授权 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:name=<span class="string">&quot;android.permission.ACCESS_NETWORK_STATE&quot;</span>/&gt;</span><br><span class="line">&lt;uses-permission android:name=<span class="string">&quot;android.permission.INTERNET&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>
<p>启动web服务端，再运行程序，最后使用之前的tcp hook代码进行hook </p>
<p><img src="https://i.loli.net/2021/11/04/hAHnc1mN5kxUWaF.png" alt="Untitled"></p>

  </div>
  <div class="post-meta">
    <span class="post-time" style="color:#646060;font-size:13px">2021-11-04</span>
  </div>

  <div class="post-footer">
    

    <a href="#top" class="top">返回顶部</a>
  </div>
</article>

<!-- 评论插件 -->

<footer>
  2021
  <span class="author">
    tutucoo
  </span>
</footer>


    </div>
  </body>
</html>