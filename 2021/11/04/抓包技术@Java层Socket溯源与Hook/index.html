<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>抓包技术@Java层Socket溯源与Hook - 打渔为生</title>
  <link rel="icon" href="https://i.imgur.com/SrZt9VU.jpg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=>
  
    <meta name="description" content="全平台漏洞挖掘手记">
  
  
  
    <link rel="alternate" href="/atom.xml " title="打渔为生" type="application/atom+xml">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.3.0"></head>

  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">打渔为生</a>
    <div class="subtitle">tutucoo的技术笔记</div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">主页</a>
        </li>
      
        <li class="menu-item">
          <a href="/summary" class="menu-item-link">Summary</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">关于</a>
        </li>
      
        <li class="menu-item">
          <a href="/atom.xml" class="menu-item-link">RSS</a>
        </li>
      
    </ul>
  </nav>
</header>

<article class="post">
  <div class="post-title">
    <h1 class="article-title">抓包技术@Java层Socket溯源与Hook</h1>
  </div>

  <!-- 文章目录 -->
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Java%E5%B1%82socket%E6%BA%AF%E6%BA%90"><span class="toc-text">Java层socket溯源</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#hook-Java%E5%B1%82tcp-socket%E6%8E%A5%E5%8F%A3"><span class="toc-text">hook Java层tcp socket接口</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#hook-Java%E5%B1%82udp-socket%E6%8E%A5%E5%8F%A3"><span class="toc-text">hook Java层udp socket接口</span></a></li></ol>

  <div class="post-content">
    <h1 id="Java层socket溯源"><a href="#Java层socket溯源" class="headerlink" title="Java层socket溯源"></a>J<strong>ava层socket溯源</strong></h1><p>可以通过AS动态调试进行溯源</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">java.net.Socket类构造函数: new Socket(ip,port);-&gt;Socket(InetAddress[] addresses,int port,SocketAddress localAddr,boolean stream)&gt;impl-&gt;java.net.SocksSocketImpl-&gt;</span><br><span class="line"></span><br><span class="line">建立连接：connect(SocketAddress endpoint)</span><br><span class="line"></span><br><span class="line">接收数据：java.net.SocketInputStream.read(byte[])-&gt;read(b,0,b.length)-&gt;read(b,off,length,impl.getTimeout())-&gt;socketRead(fd, b, off, length, timeout);(native) </span><br><span class="line"></span><br><span class="line">发送数据: java.net.SocketOutputStream.write(byte[])-&gt;socketWrite(b,0,b.length)-&gt;socketWrite0(fd,b,off,len)</span><br></pre></td></tr></table></figure>
<p>接收数据的read函数所在的类是一个虚类，那么就有一个实现的类，可以动态调试时看这个对象的shadow$_klass的值，这个值就是它的实现类，这里的值是java.net.SocketInputStream，再通过查看源码找到这个类的具体实现</p>
<p>可以看到接收数据调用read函数后，最终会调用socketRead0函数，这个函数是native层的函数，只要对这个函数进行hook就可以拦截所有的tcp流量</p>
<p><img src="https://i.loli.net/2021/11/04/V79YrByHfgeLUMt.png" alt="Untitled"></p>
<p>有些情况是通过udp进行通信的，比如说http/2就是通过发送udp请求进行通信的</p>
<p>发送数据，源码函数位于java.net.DatagramSocket.send</p>
<p><img src="https://i.loli.net/2021/11/04/YMtnd2KG8bToE1u.png" alt="Untitled"></p>
<p>send内部调用了getImpl.send函数</p>
<p><img src="https://i.loli.net/2021/11/04/d8tMnQOh24AEL6s.png" alt="Untitled"></p>
<p>getImpl函数的作用是获取实例，通过这个实例来执行send</p>
<p>getImpl内部调用了createImpl函数</p>
<p><img src="https://i.loli.net/2021/11/04/FzEwICj6gd7QUp8.png" alt="Untitled"></p>
<p>通过动态调试知道获取的实例是PlainDatagramSocketImpl</p>
<p><img src="https://i.loli.net/2021/11/04/ozyZFJVcAKRgj8f.png" alt="Untitled"></p>
<p>找到PlainDatagramSocketImpl.send的实现，内部调用了IoBridge.sendto</p>
<p><img src="https://i.loli.net/2021/11/04/p98cVdLWPMIOqlv.png" alt="Untitled"></p>
<p>再进入内部是Libcore.os.sendto</p>
<p><img src="https://i.loli.net/2021/11/04/YlympP8UOCzB7Qb.png" alt="Untitled"></p>
<p>这里直接跳转sendto，找不到正确的位置，需要先找到Libcore类</p>
<p>Libcore类的内部有个os变量，属于BlockGuardOs类</p>
<p><img src="https://i.loli.net/2021/11/04/KFmoXaQTVRfHvn7.png" alt="Untitled"></p>
<p>进入BlockGuardOs类找到sendto</p>
<p><img src="https://i.loli.net/2021/11/04/S1lCjbFiUkqm8tL.png" alt="Untitled"></p>
<p>这里可以看到通过os调用的sendto，os是在BlockGuardOs初始化时传入的，是在父类中进行处理的</p>
<p><img src="https://i.loli.net/2021/11/04/TBQKIeZ5D4iwqCX.png" alt="Untitled"></p>
<p>os属于Os类</p>
<p><img src="https://i.loli.net/2021/11/04/1XVQZgOWenpPJLo.png" alt="Untitled"></p>
<p>Os类有sendto接口</p>
<p><img src="https://i.loli.net/2021/11/04/O3tQYZiA1d8qaJB.png" alt="Untitled"></p>
<p>通过搜索sendto，找到Linux.java</p>
<p><img src="https://i.loli.net/2021/11/04/6xDSikNloyWbQGu.png" alt="Untitled"></p>
<p>这样就找到了这个函数的实现，最终调用了native层的setntoBytes</p>
<p><img src="https://i.loli.net/2021/11/04/9gJW4NTm5pvVM3O.png" alt="Untitled"></p>
<p>接收数据，跟发送数据类似，找到DatagramSocket的receive函数，内部调用了getImpl</p>
<p><img src="https://i.loli.net/2021/11/04/uhMNUxABGc5X2yz.png" alt="Untitled"></p>
<p>通过动态调试获取到PlainDatagramSocketImp，找到receive函数，内部调用了doRecv</p>
<p><img src="https://i.loli.net/2021/11/04/aubsVve96oqWHkP.png" alt="Untitled"></p>
<p>doRecv内部调用了IoBridge.recvfrom</p>
<p><img src="https://i.loli.net/2021/11/04/iv6O4jC1Bhl9JYe.png" alt="Untitled"></p>
<p>然后找到Libcore.os.recvfrom</p>
<p><img src="https://i.loli.net/2021/11/04/AXuhE8lOmStMDdC.png" alt="Untitled"></p>
<p>直接搜索recvfrom可以看到在Linux.java中有实现，找到最终的函数recvfromBytes</p>
<p><img src="https://i.loli.net/2021/11/04/pNMZfoE5hV7QqBl.png" alt="Untitled"></p>
<h1 id="hook-Java层tcp-socket接口"><a href="#hook-Java层tcp-socket接口" class="headerlink" title="hook Java层tcp socket接口"></a>hook Java层tcp socket接口</h1><p>运行tcp服务器和客户端，方便进行测试</p>
<p>服务端</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># coding=utf-8</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">socket_list = []</span><br><span class="line"></span><br><span class="line">s = socket.socket()</span><br><span class="line">s.bind((<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">9999</span>))</span><br><span class="line">s.listen()</span><br><span class="line">def read_from_client(s):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">return</span> s.recv(<span class="number">1024</span>).decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    except:</span><br><span class="line">        socket_list.remove(s)</span><br><span class="line">def server_target(s):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">while</span> True:</span><br><span class="line">            content = read_from_client(s)</span><br><span class="line">            <span class="keyword">if</span> content is None:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            length=len(content)</span><br><span class="line">            <span class="keyword">if</span> length&gt;<span class="number">0</span>:</span><br><span class="line">                print(<span class="string">&quot;receive:&quot;</span>+content)</span><br><span class="line">                response=content+<span class="string">&quot; from server&quot;</span></span><br><span class="line">                print(<span class="string">&quot;send:&quot;</span>+response)</span><br><span class="line">                s.send(response.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    except IOError <span class="keyword">as</span> e:</span><br><span class="line">        print(e.strerror)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> True:</span><br><span class="line">    c, addr = s.accept() </span><br><span class="line">    socket_list.append(c)</span><br><span class="line">    threading.Thread(target=server_target, args=(c,)).start()</span><br></pre></td></tr></table></figure>
<p>客户端</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">TcpClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="built_in">String</span> ip = <span class="string">&quot;192.168.18.244&quot;</span>;</span><br><span class="line">    public <span class="keyword">static</span> int port = <span class="number">9999</span>;</span><br><span class="line">    public <span class="keyword">static</span> boolean connected = <span class="literal">false</span>;</span><br><span class="line">    public <span class="keyword">static</span> Socket socket = <span class="literal">null</span>;</span><br><span class="line">    public <span class="keyword">static</span> OutputStream outputstream = <span class="literal">null</span>;</span><br><span class="line">    public <span class="keyword">static</span> InputStream inputStream = <span class="literal">null</span>;</span><br><span class="line">    public <span class="keyword">static</span> long lastheartresponse = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> <span class="function"><span class="title">start</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        servicethread();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> Long <span class="function"><span class="title">getTimestamp</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="built_in">Date</span> date = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">        <span class="keyword">if</span> (<span class="literal">null</span> == date) &#123;</span><br><span class="line">            <span class="keyword">return</span> (long) <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">String</span> timestamp = <span class="built_in">String</span>.valueOf(date.getTime());</span><br><span class="line">        <span class="keyword">return</span> Long.valueOf(timestamp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> <span class="function"><span class="title">close</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (socket != <span class="literal">null</span>) &#123;</span><br><span class="line">                socket.close();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        inputStream = <span class="literal">null</span>;</span><br><span class="line">        outputstream = <span class="literal">null</span>;</span><br><span class="line">        connected = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> <span class="function"><span class="title">sendmsg</span>(<span class="params">final <span class="built_in">String</span> msg</span>)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> <span class="function"><span class="title">Runnable</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public <span class="keyword">void</span> <span class="function"><span class="title">run</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (connected == <span class="literal">false</span>) &#123;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="keyword">if</span> (outputstream != <span class="literal">null</span>) &#123;</span><br><span class="line">                            <span class="built_in">String</span> crypt = msg;</span><br><span class="line">                            outputstream.write(crypt.getBytes(<span class="string">&quot;utf-8&quot;</span>));</span><br><span class="line">                            outputstream.flush();</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        close();</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> <span class="function"><span class="title">heartthread</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> <span class="function"><span class="title">Runnable</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public <span class="keyword">void</span> <span class="function"><span class="title">run</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    long currenttime = getTimestamp();</span><br><span class="line">                    <span class="keyword">if</span> (lastheartresponse != <span class="number">0</span>) &#123;</span><br><span class="line">                        long offset = currenttime - lastheartresponse;</span><br><span class="line">                        int seconds = (int) (offset / <span class="number">1000</span>);</span><br><span class="line">                        <span class="keyword">if</span> (seconds &gt; <span class="number">10</span>) &#123;</span><br><span class="line">                            close();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.currentThread().sleep(<span class="number">5000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> <span class="function"><span class="title">receivethread</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> <span class="function"><span class="title">Runnable</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public <span class="keyword">void</span> <span class="function"><span class="title">run</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">                int arraysize = <span class="number">1024</span>;</span><br><span class="line">                byte[] content = <span class="keyword">new</span> byte[arraysize];</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (inputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            int count = inputStream.read(content);</span><br><span class="line">                            <span class="keyword">if</span> (count &gt; <span class="number">0</span> &amp;&amp; count &lt; arraysize) &#123;</span><br><span class="line">                                byte[] tmparray = <span class="keyword">new</span> byte[count];</span><br><span class="line">                                System.arraycopy(content, <span class="number">0</span>, tmparray, <span class="number">0</span>, count);</span><br><span class="line">                                <span class="built_in">String</span> str = <span class="keyword">new</span> <span class="built_in">String</span>(tmparray, <span class="string">&quot;utf-8&quot;</span>);</span><br><span class="line"></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                            close();</span><br><span class="line">                            <span class="keyword">break</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        close();</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="keyword">static</span> <span class="keyword">void</span> <span class="function"><span class="title">servicethread</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> <span class="function"><span class="title">Runnable</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">            @Override</span><br><span class="line">            public <span class="keyword">void</span> <span class="function"><span class="title">run</span>(<span class="params"></span>)</span> &#123;</span><br><span class="line">                heartthread();</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (connected == <span class="literal">false</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            socket = <span class="keyword">new</span> Socket(ip, port);</span><br><span class="line">                            socket.setSoTimeout(<span class="number">10</span>*<span class="number">1000</span>);</span><br><span class="line">                            connected = <span class="literal">true</span>;</span><br><span class="line">                            outputstream = socket.getOutputStream();</span><br><span class="line">                            inputStream = socket.getInputStream();</span><br><span class="line">                            receivethread();</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                            connected = <span class="literal">false</span>;</span><br><span class="line">                            socket = <span class="literal">null</span>;</span><br><span class="line">                            outputstream = <span class="literal">null</span>;</span><br><span class="line">                            inputStream = <span class="literal">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (outputstream != <span class="literal">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            JSONObject object = <span class="keyword">new</span> JSONObject();</span><br><span class="line">                            object.put(<span class="string">&quot;msgtype&quot;</span>, <span class="string">&quot;tutucoo&quot;</span>);</span><br><span class="line">                            sendmsg(object.toString());</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">                            e.printStackTrace();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.currentThread().sleep(<span class="number">5000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在AndroidManifest.xml文件中添加权限 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:name=<span class="string">&quot;android.permission.INTERNET&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>
<p>在MainActivity中启动客户端</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">TcpClient.start();</span><br></pre></td></tr></table></figure>
<p>frida脚本如下：</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LogPrint</span>(<span class="params">log</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> theDate = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">    <span class="keyword">var</span> hour = theDate.getHours();</span><br><span class="line">    <span class="keyword">var</span> minute = theDate.getMinutes();</span><br><span class="line">    <span class="keyword">var</span> second = theDate.getSeconds();</span><br><span class="line">    <span class="keyword">var</span> mSecond = theDate.getMilliseconds();</span><br><span class="line"></span><br><span class="line">    hour &lt; <span class="number">10</span> ? hour = <span class="string">&quot;0&quot;</span> + hour : hour;</span><br><span class="line">    minute &lt; <span class="number">10</span> ? minute = <span class="string">&quot;0&quot;</span> + minute : minute;</span><br><span class="line">    second &lt; <span class="number">10</span> ? second = <span class="string">&quot;0&quot;</span> + second : second;</span><br><span class="line">    mSecond &lt; <span class="number">10</span> ? mSecond = <span class="string">&quot;00&quot;</span> + mSecond : mSecond &lt; <span class="number">100</span> ? mSecond = <span class="string">&quot;0&quot;</span> + mSecond : mSecond;</span><br><span class="line">    <span class="keyword">var</span> time = hour + <span class="string">&quot;:&quot;</span> + minute + <span class="string">&quot;:&quot;</span> + second + <span class="string">&quot;:&quot;</span> + mSecond;</span><br><span class="line">    <span class="keyword">var</span> threadid = Process.getCurrentThreadId();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[&quot;</span> + time + <span class="string">&quot;]&quot;</span> + <span class="string">&quot;-&gt;threadid:&quot;</span> + threadid + <span class="string">&quot;--&quot;</span> + log);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printJavaStack</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> Exception = Java.use(<span class="string">&quot;java.lang.Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> ins = Exception.$new(<span class="string">&quot;Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> straces = ins.getStackTrace();</span><br><span class="line">        <span class="keyword">if</span> (straces != <span class="literal">undefined</span> &amp;&amp; straces != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> strace = straces.toString();</span><br><span class="line">            <span class="keyword">var</span> replaceStr = strace.replace(<span class="regexp">/,/g</span>, <span class="string">&quot; \n &quot;</span>);</span><br><span class="line">            LogPrint(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack strat=======================&quot;</span>);</span><br><span class="line">            LogPrint(replaceStr);</span><br><span class="line">            LogPrint(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack end======================= \n &quot;</span>);</span><br><span class="line">            Exception.$dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isprintable</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (value &gt;= <span class="number">32</span> &amp;&amp; value &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hooktcp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> SocketClass = Java.use(<span class="string">&#x27;java.net.Socket&#x27;</span>);</span><br><span class="line">				<span class="comment">//构造函数的参数分别是ip和port</span></span><br><span class="line">        SocketClass.$init.overload(<span class="string">&#x27;java.lang.String&#x27;</span>, <span class="string">&#x27;int&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">arg0, arg1</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;[&quot;</span> + Process.getCurrentThreadId() + <span class="string">&quot;]new Socket connection:&quot;</span> + arg0 + <span class="string">&quot;,port:&quot;</span> + arg1);</span><br><span class="line">            printJavaStack(<span class="string">&#x27;tcp connect...&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.$init(arg0, arg1);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> SocketInputStreamClass = Java.use(<span class="string">&#x27;java.net.SocketInputStream&#x27;</span>);</span><br><span class="line">        SocketInputStreamClass.socketRead0.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">arg0, arg1, arg2, arg3, arg4</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> size = <span class="built_in">this</span>.socketRead0(arg0, arg1, arg2, arg3, arg4);</span><br><span class="line">            <span class="keyword">var</span> bytearray = Java.array(<span class="string">&#x27;byte&#x27;</span>, arg1);</span><br><span class="line">            <span class="keyword">var</span> content = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isprintable(bytearray[i])) &#123;</span><br><span class="line">                    content = content + <span class="built_in">String</span>.fromCharCode(bytearray[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> socketimpl = <span class="built_in">this</span>.impl.value;</span><br><span class="line">            <span class="keyword">var</span> address = socketimpl.address.value;</span><br><span class="line">            <span class="keyword">var</span> port = socketimpl.port.value;</span><br><span class="line">						<span class="comment">//ip、port、内容 </span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;\naddress:&quot;</span> + address + <span class="string">&quot;,port&quot;</span> + port + <span class="string">&quot;\n&quot;</span> + <span class="built_in">JSON</span>.stringify(<span class="built_in">this</span>.socket.value) + <span class="string">&quot;\n[&quot;</span> + Process.getCurrentThreadId() + <span class="string">&quot;]receive:&quot;</span> + content);</span><br><span class="line">            printJavaStack(<span class="string">&#x27;socketRead0&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> size;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">var</span> SocketOutPutStreamClass = Java.use(<span class="string">&#x27;java.net.SocketOutputStream&#x27;</span>);</span><br><span class="line">        SocketOutPutStreamClass.socketWrite0.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">arg0, arg1, arg2, arg3</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> result = <span class="built_in">this</span>.socketWrite0(arg0, arg1, arg2, arg3);</span><br><span class="line">            <span class="comment">//console.log(&quot;[&quot; + Process.getCurrentThreadId() + &quot;]socketWrite0:len:&quot; + arg3 + &quot;--content:&quot; + JSON.stringify(arg1));</span></span><br><span class="line">            <span class="keyword">var</span> bytearray = Java.array(<span class="string">&#x27;byte&#x27;</span>, arg1);</span><br><span class="line">            <span class="keyword">var</span> content = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; arg3; i++) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (isprintable(bytearray[i])) &#123;</span><br><span class="line">                    content = content + <span class="built_in">String</span>.fromCharCode(bytearray[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> socketimpl = <span class="built_in">this</span>.impl.value;</span><br><span class="line">            <span class="keyword">var</span> address = socketimpl.address.value;</span><br><span class="line">            <span class="keyword">var</span> port = socketimpl.port.value;</span><br><span class="line">						<span class="comment">//ip、port、内容 </span></span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;send address:&quot;</span> + address + <span class="string">&quot;,port&quot;</span> + port + <span class="string">&quot;[&quot;</span> + Process.getCurrentThreadId() + <span class="string">&quot;]send:&quot;</span> + content);</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;\n&quot;</span> + <span class="built_in">JSON</span>.stringify(<span class="built_in">this</span>.socket.value) + <span class="string">&quot;\n[&quot;</span> + Process.getCurrentThreadId() + <span class="string">&quot;]send:&quot;</span> + content);</span><br><span class="line">            printJavaStack(<span class="string">&#x27;socketWrite0&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    hooktcp();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure>
<p>打印出了ip、port、传输内容等信息</p>
<p><img src="https://i.loli.net/2021/11/04/E8vLb3cz7k1VDq5.png" alt="Untitled"></p>
<h1 id="hook-Java层udp-socket接口"><a href="#hook-Java层udp-socket接口" class="headerlink" title="hook Java层udp socket接口"></a>hook Java层udp socket接口</h1><p>udp服务端</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line">s = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">s.bind((<span class="string">&quot;0.0.0.0&quot;</span>, <span class="number">8888</span>))</span><br><span class="line">print(<span class="string">&quot;UDP bound on port 8888...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    data, addr = s.recvfrom(<span class="number">1024</span>)</span><br><span class="line">    print(<span class="string">&quot;Receive from %s:%s&quot;</span> %(data,addr))</span><br><span class="line">    <span class="keyword">if</span> data == <span class="string">b&quot;exit&quot;</span>:</span><br><span class="line">        s.sendto(<span class="string">b&quot;Good bye!\n&quot;</span>, addr)</span><br><span class="line">        <span class="keyword">continue</span></span><br><span class="line">    response=<span class="built_in">str</span>(data)+<span class="string">&quot; received from udpserver&quot;</span></span><br><span class="line">    s.sendto(response.encode(<span class="string">&quot;utf-8&quot;</span>), addr)</span><br></pre></td></tr></table></figure>
<p>udp客户端</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.myapplication;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.DatagramPacket;</span><br><span class="line"><span class="keyword">import</span> java.net.DatagramSocket;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.SocketException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UdpClient</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEST_PORT = <span class="number">8888</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEST_IP = <span class="string">&quot;192.168.2.104&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DATA_LEN = <span class="number">4096</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] inBuff = <span class="keyword">new</span> <span class="keyword">byte</span>[DATA_LEN];</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DatagramSocket socket;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            socket = <span class="keyword">new</span> DatagramSocket();</span><br><span class="line">            receivethread();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SocketException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DatagramPacket inPacket = <span class="keyword">new</span> DatagramPacket(inBuff, inBuff.length);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> DatagramPacket outPacket = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">udpsend</span><span class="params">(String content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            outPacket = <span class="keyword">new</span> DatagramPacket(<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>], <span class="number">0</span>, InetAddress.getByName(DEST_IP), DEST_PORT);</span><br><span class="line">            <span class="keyword">byte</span>[] buff = content.getBytes();</span><br><span class="line">            outPacket.setData(buff);</span><br><span class="line">            socket.send(outPacket);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">receivethread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        socket.receive(inPacket);</span><br><span class="line">                        Log.i(<span class="string">&quot;udpreceive&quot;</span>, <span class="keyword">new</span> String(inBuff, <span class="number">0</span>, inPacket.getLength()));</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Thread.currentThread().sleep(<span class="number">1000</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                    udpsend(<span class="string">&quot;i am from udpclient!&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>AndroidManifest.xml中添加网络权限 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;uses-permission android:name=<span class="string">&quot;android.permission.INTERNET&quot;</span>/&gt;</span><br></pre></td></tr></table></figure>
<p>MainActivity中调用 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">UdpClient.start();</span><br></pre></td></tr></table></figure>
<p>hook脚本</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LogPrint</span>(<span class="params">log</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> theDate = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">    <span class="keyword">var</span> hour = theDate.getHours();</span><br><span class="line">    <span class="keyword">var</span> minute = theDate.getMinutes();</span><br><span class="line">    <span class="keyword">var</span> second = theDate.getSeconds();</span><br><span class="line">    <span class="keyword">var</span> mSecond = theDate.getMilliseconds();</span><br><span class="line"></span><br><span class="line">    hour &lt; <span class="number">10</span> ? hour = <span class="string">&quot;0&quot;</span> + hour : hour;</span><br><span class="line">    minute &lt; <span class="number">10</span> ? minute = <span class="string">&quot;0&quot;</span> + minute : minute;</span><br><span class="line">    second &lt; <span class="number">10</span> ? second = <span class="string">&quot;0&quot;</span> + second : second;</span><br><span class="line">    mSecond &lt; <span class="number">10</span> ? mSecond = <span class="string">&quot;00&quot;</span> + mSecond : mSecond &lt; <span class="number">100</span> ? mSecond = <span class="string">&quot;0&quot;</span> + mSecond : mSecond;</span><br><span class="line">    <span class="keyword">var</span> time = hour + <span class="string">&quot;:&quot;</span> + minute + <span class="string">&quot;:&quot;</span> + second + <span class="string">&quot;:&quot;</span> + mSecond;</span><br><span class="line">    <span class="keyword">var</span> threadid = Process.getCurrentThreadId();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[&quot;</span> + time + <span class="string">&quot;]&quot;</span> + <span class="string">&quot;-&gt;threadid:&quot;</span> + threadid + <span class="string">&quot;--&quot;</span> + log);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printJavaStack</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> Exception = Java.use(<span class="string">&quot;java.lang.Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> ins = Exception.$new(<span class="string">&quot;Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> straces = ins.getStackTrace();</span><br><span class="line">        <span class="keyword">if</span> (straces != <span class="literal">undefined</span> &amp;&amp; straces != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> strace = straces.toString();</span><br><span class="line">            <span class="keyword">var</span> replaceStr = strace.replace(<span class="regexp">/,/g</span>, <span class="string">&quot; \n &quot;</span>);</span><br><span class="line">            LogPrint(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack strat=======================&quot;</span>);</span><br><span class="line">            LogPrint(replaceStr);</span><br><span class="line">            LogPrint(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack end======================= \n &quot;</span>);</span><br><span class="line">            Exception.$dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isprintable</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (value &gt;= <span class="number">32</span> &amp;&amp; value &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookudp</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> LinuxClass = Java.use(<span class="string">&#x27;libcore.io.Linux&#x27;</span>);</span><br><span class="line">        <span class="comment">//private native int recvfromBytes(FileDescriptor fd, Object buffer, int byteOffset, int byteCount, int flags, InetSocketAddress srcAddress) throws ErrnoException, SocketException;</span></span><br><span class="line">        LinuxClass.recvfromBytes.implementation = <span class="function"><span class="keyword">function</span> (<span class="params">arg0, arg1, arg2, arg3, arg4, arg5</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> size = <span class="built_in">this</span>.recvfromBytes(arg0, arg1, arg2, arg3, arg4, arg5);</span><br><span class="line">            <span class="keyword">var</span> bytearray = Java.array(<span class="string">&#x27;byte&#x27;</span>, arg1);</span><br><span class="line">            <span class="keyword">var</span> content = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (isprintable(bytearray[i])) &#123;</span><br><span class="line">                    content = content + <span class="built_in">String</span>.fromCharCode(bytearray[i]);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;address:&quot;</span> + arg5 + <span class="string">&quot; [&quot;</span> + Process.getCurrentThreadId() + <span class="string">&quot;]recvfromBytes:size:&quot;</span> + size + <span class="string">&quot;,content:&quot;</span> + <span class="built_in">JSON</span>.stringify(arg1) + <span class="string">&quot;---content,&quot;</span> + content);</span><br><span class="line">            printJavaStack(<span class="string">&#x27;recvfromBytes&#x27;</span>);</span><br><span class="line">            <span class="keyword">return</span> size;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//private native int sendtoBytes(FileDescriptor fd, Object buffer, int byteOffset, int byteCount, int flags, InetAddress inetAddress, int port) throws ErrnoException, SocketException;</span></span><br><span class="line">        <span class="comment">// private native int sendtoBytes(FileDescriptor fd, Object buffer, int byteOffset, int byteCount, int flags, SocketAddress address) throws ErrnoException, SocketException;</span></span><br><span class="line">        LinuxClass.sendtoBytes.overload(<span class="string">&#x27;java.io.FileDescriptor&#x27;</span>, <span class="string">&#x27;java.lang.Object&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;java.net.InetAddress&#x27;</span>, <span class="string">&#x27;int&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">arg0, arg1, arg2, arg3, arg4, arg5, arg6</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> size = <span class="built_in">this</span>.sendtoBytes(arg0, arg1, arg2, arg3, arg4, arg5, arg6);</span><br><span class="line">            <span class="keyword">var</span> bytearray = Java.array(<span class="string">&#x27;byte&#x27;</span>, arg1);</span><br><span class="line">            <span class="keyword">var</span> content = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isprintable(bytearray[i])) &#123;</span><br><span class="line">                    content = content + <span class="built_in">String</span>.fromCharCode(bytearray[i]);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;address:&quot;</span> + arg5 + <span class="string">&quot;,port&quot;</span> + arg6 + <span class="string">&quot; [&quot;</span> + Process.getCurrentThreadId() + <span class="string">&quot;]LinuxClass11.sendtoBytes:len:&quot;</span> + size + <span class="string">&quot;--content:&quot;</span> + <span class="built_in">JSON</span>.stringify(arg1) + <span class="string">&quot;--content:&quot;</span> + content);</span><br><span class="line">            printJavaStack(<span class="string">&#x27;LinuxClass11.sendtoBytes&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> size;</span><br><span class="line">        &#125;</span><br><span class="line">				<span class="comment">//sendtoBytes有两个实现，因此都要进行hook</span></span><br><span class="line">        LinuxClass.sendtoBytes.overload(<span class="string">&#x27;java.io.FileDescriptor&#x27;</span>, <span class="string">&#x27;java.lang.Object&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;int&#x27;</span>, <span class="string">&#x27;java.net.SocketAddress&#x27;</span>).implementation = <span class="function"><span class="keyword">function</span> (<span class="params">arg0, arg1, arg2, arg3, arg4, arg5</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> size = <span class="built_in">this</span>.sendtoBytes(arg0, arg1, arg2, arg3, arg4, arg5);</span><br><span class="line">            <span class="keyword">var</span> bytearray = Java.array(<span class="string">&#x27;byte&#x27;</span>, arg1);</span><br><span class="line">            <span class="keyword">var</span> content = <span class="string">&quot;&quot;</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isprintable(bytearray[i])) &#123;</span><br><span class="line">                    content = content + <span class="built_in">String</span>.fromCharCode(bytearray[i]);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">&quot;address:&quot;</span> + arg5 + <span class="string">&quot; [&quot;</span> + Process.getCurrentThreadId() + <span class="string">&quot;]LinuxClass22.sendtoBytes:len:&quot;</span> + size + <span class="string">&quot;--content:&quot;</span> + <span class="built_in">JSON</span>.stringify(arg1) + <span class="string">&quot;,content:&quot;</span> + content);</span><br><span class="line">            printJavaStack(<span class="string">&#x27;LinuxClass22.sendtoBytes&#x27;</span>)</span><br><span class="line">            <span class="keyword">return</span> size;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    hookudp();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main)</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2021/11/04/6WdQKn149VRxC3E.png" alt="Untitled"></p>

  </div>
  <div class="post-meta">
    <span class="post-time" style="color:#646060;font-size:13px">2021-11-04</span>
  </div>

  <div class="post-footer">
    

    <a href="#top" class="top">返回顶部</a>
  </div>
</article>

<!-- 评论插件 -->

<footer>
  2021
  <span class="author">
    tutucoo
  </span>
</footer>


    </div>
  </body>
</html>