<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>抓包技术@Jni层SSL溯源与Hook - 打渔为生</title>
  <link rel="icon" href="https://i.imgur.com/SrZt9VU.jpg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=>
  
    <meta name="description" content="全平台漏洞挖掘手记">
  
  
  
    <link rel="alternate" href="/atom.xml " title="打渔为生" type="application/atom+xml">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.3.0"></head>

  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">打渔为生</a>
    <div class="subtitle">tutucoo的技术笔记</div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">主页</a>
        </li>
      
        <li class="menu-item">
          <a href="/summary" class="menu-item-link">Summary</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">关于</a>
        </li>
      
        <li class="menu-item">
          <a href="/atom.xml" class="menu-item-link">RSS</a>
        </li>
      
    </ul>
  </nav>
</header>

<article class="post">
  <div class="post-title">
    <h1 class="article-title">抓包技术@Jni层SSL溯源与Hook</h1>
  </div>

  <!-- 文章目录 -->
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Jni%E5%B1%82SSL%E6%BA%AF%E6%BA%90%E4%B8%8EHook"><span class="toc-text">Jni层SSL溯源与Hook</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A6%82%E8%BF%B0"><span class="toc-text">概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#jni%E5%B1%82SSL%E6%BA%AF%E6%BA%90"><span class="toc-text">jni层SSL溯源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JNI-SSL-Hook"><span class="toc-text">JNI SSL Hook</span></a></li></ol></li></ol>

  <div class="post-content">
    <h1 id="Jni层SSL溯源与Hook"><a href="#Jni层SSL溯源与Hook" class="headerlink" title="Jni层SSL溯源与Hook"></a>Jni层SSL溯源与Hook</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>第一种情况：使用Java层SSL库进行通信，hook SSLInputStreamClass.read函数</p>
<p>第二种情况：使用系统lib SSL库(boringssl)进行通信，hook SSL_write函数</p>
<p>第三种情况：自定义Openssl库进行通信，清除掉符号的情况hook read函数，没有清除符号还是hook SSL_write函数，自定义openssl库一般还是会调用这个函数</p>
<h2 id="jni层SSL溯源"><a href="#jni层SSL溯源" class="headerlink" title="jni层SSL溯源"></a>jni层SSL溯源</h2><p>Java层最后调用的函数是SSL_write，Android源码中找到SSL_write函数 </p>
<p><img src="https://i.loli.net/2021/11/05/dJnGRPb6MA9wkFS.png" alt="Untitled"></p>
<p>找到所在的cpp文件，找到代码实现</p>
<p><img src="https://i.loli.net/2021/11/05/NqwAkJxiUr7b6Oa.png" alt="Untitled"></p>
<p>NativeCrypto_SSL_write函数实现</p>
<p><img src="https://i.loli.net/2021/11/05/tyAZLVGNjl53KYW.png" alt="Untitled"></p>
<p>接着在内部调用sslWrite函数  </p>
<p><img src="https://i.loli.net/2021/11/05/WLQZlFrTcsi3uSw.png" alt="Untitled"></p>
<p>然后调用SSL_write函数 </p>
<p><img src="https://i.loli.net/2021/11/05/PqzrD86LpvFTWYm.png" alt="Untitled"></p>
<p>全局搜索，在boringssl库中找到SSL_write函数 </p>
<p><img src="https://i.loli.net/2021/11/05/LKvBihts5roApMO.png" alt="Untitled"></p>
<p>找到它的实现</p>
<p><img src="https://i.loli.net/2021/11/05/3qvUBzHZG7Rhokj.png" alt="Untitled"></p>
<p>看下SSL_write的实现</p>
<p><img src="https://i.loli.net/2021/11/05/tmlDBRxGrsPA59I.png" alt="Untitled"></p>
<p>内部调用ssl→method→write_app_data</p>
<p><img src="https://i.loli.net/2021/11/05/VteQ5DMsUpgnSc6.png" alt="Untitled"></p>
<p>这个ssl里面有method常量</p>
<p><img src="https://i.loli.net/2021/11/05/WSyUcHXTAGZxw9g.png" alt="Untitled"></p>
<p>找到ssl_protocol_method_st</p>
<p><img src="https://i.loli.net/2021/11/05/vX2YzkmhcO9bquB.png" alt="Untitled"></p>
<p>内部存在一个write_app_data函数指针</p>
<p><img src="https://i.loli.net/2021/11/05/hDAYaLfrxZkGB3u.png" alt="Untitled"></p>
<p>根据不同的协议会调用不同的实现，这里会调用ssl3_write_app_data</p>
<p><img src="https://i.loli.net/2021/11/05/IoCtLdg8iuA1pzZ.png" alt="Untitled"></p>
<p>进入ssl3_writre_app_data方法</p>
<p><img src="https://i.loli.net/2021/11/05/gnHjUyZrkoa1NxQ.png" alt="Untitled"></p>
<p>看到do_ssl3_write方法，执行完这个方法后明文就会进行加密</p>
<p><img src="https://i.loli.net/2021/11/05/mQ3XktfPARpas18.png" alt="Untitled"></p>
<p>接着进入到ssl3_write_pending函数 </p>
<p><img src="https://i.loli.net/2021/11/05/PfdDlY6W9eTxgAH.png" alt="Untitled"></p>
<p>然后调用ssl_write_buffer_flush</p>
<p><img src="https://i.loli.net/2021/11/05/Gnrpcx5KEid6RkJ.png" alt="Untitled"></p>
<p>然后会进入tls_write_buffer_flush</p>
<p><img src="https://i.loli.net/2021/11/05/3hRPWaDy2C8wszF.png" alt="Untitled"></p>
<p>然后进入到BIO_write</p>
<p><img src="https://i.loli.net/2021/11/05/Xs4rSJUaeWAq5gb.png" alt="Untitled"></p>
<p>内部调用了bio_io</p>
<p><img src="https://i.loli.net/2021/11/05/lIXtex5gBpHmucZ.png" alt="Untitled"></p>
<p>进入bio_io</p>
<p><img src="https://i.loli.net/2021/11/05/JU8DKXpgt9TZjmQ.png" alt="Untitled"></p>
<p>找到boringssl源码，最终会调用sock_read和sock_write，内部又调用了read和write函数 ，注意这里细节，ssl底层发送没有使用send和recv，而是使用了write和read</p>
<p><img src="https://i.loli.net/2021/11/05/e5RyJHIsS617U9C.png" alt="Untitled"></p>
<h2 id="JNI-SSL-Hook"><a href="#JNI-SSL-Hook" class="headerlink" title="JNI SSL Hook"></a>JNI SSL Hook</h2><figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LogPrint</span>(<span class="params">log</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> theDate = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">    <span class="keyword">var</span> hour = theDate.getHours();</span><br><span class="line">    <span class="keyword">var</span> minute = theDate.getMinutes();</span><br><span class="line">    <span class="keyword">var</span> second = theDate.getSeconds();</span><br><span class="line">    <span class="keyword">var</span> mSecond = theDate.getMilliseconds();</span><br><span class="line"></span><br><span class="line">    hour &lt; <span class="number">10</span> ? hour = <span class="string">&quot;0&quot;</span> + hour : hour;</span><br><span class="line">    minute &lt; <span class="number">10</span> ? minute = <span class="string">&quot;0&quot;</span> + minute : minute;</span><br><span class="line">    second &lt; <span class="number">10</span> ? second = <span class="string">&quot;0&quot;</span> + second : second;</span><br><span class="line">    mSecond &lt; <span class="number">10</span> ? mSecond = <span class="string">&quot;00&quot;</span> + mSecond : mSecond &lt; <span class="number">100</span> ? mSecond = <span class="string">&quot;0&quot;</span> + mSecond : mSecond;</span><br><span class="line">    <span class="keyword">var</span> time = hour + <span class="string">&quot;:&quot;</span> + minute + <span class="string">&quot;:&quot;</span> + second + <span class="string">&quot;:&quot;</span> + mSecond;</span><br><span class="line">    <span class="keyword">var</span> threadid = Process.getCurrentThreadId();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[&quot;</span> + time + <span class="string">&quot;]&quot;</span> + <span class="string">&quot;-&gt;threadid:&quot;</span> + threadid + <span class="string">&quot;--&quot;</span> + log);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printNativeStack</span>(<span class="params">context, name</span>) </span>&#123;</span><br><span class="line">    <span class="comment">//Debug.</span></span><br><span class="line">    <span class="keyword">var</span> array = Thread.backtrace(context, Backtracer.ACCURATE);</span><br><span class="line">    <span class="keyword">var</span> first = DebugSymbol.fromAddress(array[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">if</span> (first.toString().indexOf(<span class="string">&#x27;libopenjdk.so!NET_Send&#x27;</span>) &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> trace = Thread.backtrace(context, Backtracer.ACCURATE).map(DebugSymbol.fromAddress).join(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">        LogPrint(<span class="string">&quot;-----------start:&quot;</span> + name + <span class="string">&quot;--------------&quot;</span>);</span><br><span class="line">        LogPrint(trace);</span><br><span class="line">        LogPrint(<span class="string">&quot;-----------end:&quot;</span> + name + <span class="string">&quot;--------------&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printJavaStack</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> Exception = Java.use(<span class="string">&quot;java.lang.Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> ins = Exception.$new(<span class="string">&quot;Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> straces = ins.getStackTrace();</span><br><span class="line">        <span class="keyword">if</span> (straces != <span class="literal">undefined</span> &amp;&amp; straces != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> strace = straces.toString();</span><br><span class="line">            <span class="keyword">var</span> replaceStr = strace.replace(<span class="regexp">/,/g</span>, <span class="string">&quot; \n &quot;</span>);</span><br><span class="line">            LogPrint(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack strat=======================&quot;</span>);</span><br><span class="line">            LogPrint(replaceStr);</span><br><span class="line">            LogPrint(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack end======================= \n &quot;</span>);</span><br><span class="line">            Exception.$dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isprintable</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (value &gt;= <span class="number">32</span> &amp;&amp; value &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getsocketdetail</span>(<span class="params">fd</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> type = Socket.type(fd);</span><br><span class="line">    <span class="keyword">if</span> (type != <span class="literal">null</span>) &#123;</span><br><span class="line">        result = result + <span class="string">&quot;type:&quot;</span> + type;</span><br><span class="line">        <span class="keyword">var</span> peer = Socket.peerAddress(fd);</span><br><span class="line">        <span class="keyword">var</span> local = Socket.localAddress(fd);</span><br><span class="line">        result = result + <span class="string">&quot;,address:&quot;</span> + <span class="built_in">JSON</span>.stringify(peer) + <span class="string">&quot;,local:&quot;</span> + <span class="built_in">JSON</span>.stringify(local);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getip</span>(<span class="params">ip_ptr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = ptr(ip_ptr).readU8() + <span class="string">&quot;.&quot;</span> + ptr(ip_ptr.add(<span class="number">1</span>)).readU8() + <span class="string">&quot;.&quot;</span> + ptr(ip_ptr.add(<span class="number">2</span>)).readU8() + <span class="string">&quot;.&quot;</span> + ptr(ip_ptr.add(<span class="number">3</span>)).readU8()</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hooklibc</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> libcmodule = Process.getModuleByName(<span class="string">&quot;libc.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> read_addr = libcmodule.getExportByName(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> write_addr = libcmodule.getExportByName(<span class="string">&quot;write&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(read_addr + <span class="string">&quot;---&quot;</span> + write_addr);</span><br><span class="line">    Interceptor.attach(read_addr, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.arg0 = args[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg1 = args[<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg2 = args[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.socketinfo = getsocketdetail(<span class="built_in">this</span>.arg0.toInt32());</span><br><span class="line">            LogPrint(<span class="string">&quot;go into libc.so-&gt;read_addr&quot;</span> + <span class="string">&quot;---&quot;</span> + <span class="built_in">this</span>.socketinfo);</span><br><span class="line">            <span class="built_in">this</span>.flag = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.socketinfo.indexOf(<span class="string">&quot;tcp&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.flag = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.flag) &#123;</span><br><span class="line">                printNativeStack(<span class="built_in">this</span>.context, Process.getCurrentThreadId() + <span class="string">&quot;read&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;, <span class="function"><span class="title">onLeave</span>(<span class="params">retval</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.flag) &#123;</span><br><span class="line">                <span class="keyword">var</span> size = retval.toInt32();</span><br><span class="line">                <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(Process.getCurrentThreadId() + <span class="string">&quot;---libc.so-&gt;read:&quot;</span> + hexdump(<span class="built_in">this</span>.arg1, &#123;</span><br><span class="line">                        length: size</span><br><span class="line">                    &#125;));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LogPrint(<span class="string">&quot;leave libc.so-&gt;read&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    Interceptor.attach(write_addr, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.arg0 = args[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg1 = args[<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg2 = args[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.socketinfo = getsocketdetail(<span class="built_in">this</span>.arg0.toInt32());</span><br><span class="line">            LogPrint(<span class="string">&quot;go into libc.so-&gt;write&quot;</span> + <span class="string">&quot;---&quot;</span> + <span class="built_in">this</span>.socketinfo);</span><br><span class="line">            <span class="built_in">this</span>.flag = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.socketinfo.indexOf(<span class="string">&quot;tcp&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.flag = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.flag) &#123;</span><br><span class="line">                printNativeStack(<span class="built_in">this</span>.context, Process.getCurrentThreadId() + <span class="string">&quot;write&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;, <span class="function"><span class="title">onLeave</span>(<span class="params">retval</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.flag) &#123;</span><br><span class="line">                <span class="keyword">var</span> size = ptr(<span class="built_in">this</span>.arg2).toInt32();</span><br><span class="line">                <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(Process.getCurrentThreadId() + <span class="string">&quot;---libc.so-&gt;write:&quot;</span> + hexdump(<span class="built_in">this</span>.arg1, &#123;</span><br><span class="line">                        length: size</span><br><span class="line">                    &#125;));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LogPrint(<span class="string">&quot;leave libc.so-&gt;write&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookssl</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> libcmodule = Process.getModuleByName(<span class="string">&quot;libssl.so&quot;</span>);</span><br><span class="line">		<span class="comment">//boringssl库中的函数，此时的流量是明文 </span></span><br><span class="line">    <span class="keyword">var</span> read_addr = libcmodule.getExportByName(<span class="string">&quot;SSL_read&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> write_addr = libcmodule.getExportByName(<span class="string">&quot;SSL_write&quot;</span>);</span><br><span class="line">    Interceptor.attach(read_addr, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.arg0 = args[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg1 = args[<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg2 = args[<span class="number">2</span>];</span><br><span class="line">            LogPrint(<span class="string">&quot;go into libssl.so-&gt;SSL_read&quot;</span>);</span><br><span class="line"></span><br><span class="line">            printNativeStack(<span class="built_in">this</span>.context, Process.getCurrentThreadId() + <span class="string">&quot;SSL_read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;, <span class="function"><span class="title">onLeave</span>(<span class="params">retval</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">var</span> size = retval.toInt32();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(Process.getCurrentThreadId() + <span class="string">&quot;---libssl.so-&gt;SSL_read:&quot;</span> + hexdump(<span class="built_in">this</span>.arg1, &#123;</span><br><span class="line">                    length: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line">            LogPrint(<span class="string">&quot;leave libssl.so-&gt;SSL_read&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    Interceptor.attach(write_addr, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.arg0 = args[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg1 = args[<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg2 = args[<span class="number">2</span>];</span><br><span class="line">            LogPrint(<span class="string">&quot;go into libssl.so-&gt;SSL_write&quot;</span>);</span><br><span class="line"></span><br><span class="line">            printNativeStack(<span class="built_in">this</span>.context, Process.getCurrentThreadId() + <span class="string">&quot;SSL_write&quot;</span>);</span><br><span class="line"></span><br><span class="line">        &#125;, <span class="function"><span class="title">onLeave</span>(<span class="params">retval</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> size = ptr(<span class="built_in">this</span>.arg2).toInt32();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">console</span>.log(Process.getCurrentThreadId() + <span class="string">&quot;---libssl.so-&gt;SSL_write:&quot;</span> + hexdump(<span class="built_in">this</span>.arg1, &#123;</span><br><span class="line">                    length: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LogPrint(<span class="string">&quot;leave libssl.so-&gt;SSL_write&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="comment">//可以获取加密后的流量</span></span><br><span class="line">    hooklibc();</span><br><span class="line">		<span class="comment">//可以获取到明文 </span></span><br><span class="line">    <span class="comment">//hookssl();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure>
<p>调用hooklibc函数可以看到流量都是加密的，hookssl函数中对libssl.so中的SSL_write和SSL_read进行了hook，这两个函数是boringssl库的函数，可以获取到明文 </p>
<p><img src="https://i.loli.net/2021/11/05/NXBudnM41fRpCig.png" alt="Untitled"></p>
<p>调用hookssl函数可以获取到明文  </p>
<p><img src="https://i.loli.net/2021/11/05/fQyvwkr4psibq2Y.png" alt="Untitled"></p>
<p>用c编写openssl时，需要通过SSL_set_fd函数将socket跟SSL进行绑定，参数一个为SSL *ssl,另一个为int fd，如果我们要获取通信的ip的话，我们需要直接对fd进行获取，然后再使用我们上一节的解析函数，使用frida的api进行获取ip和端口</p>
<p>发现在libssl中也有这个函数可以直接获取fd的，SSL_get_fd()，方法是可以直接返回的fd的，所以我们需要去主动调用它</p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> libcmodule = Process.getModuleByName(<span class="string">&quot;libssl.so&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> read_addr = libcmodule.getExportByName(<span class="string">&quot;SSL_read&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> write_addr = libcmodule.getExportByName(<span class="string">&quot;SSL_write&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> SSL_get_rfd_ptr=libcmodule.getExportByName(<span class="string">&quot;SSL_get_rfd&quot;</span>);</span><br><span class="line"><span class="keyword">var</span> SSL_get_rfd=<span class="keyword">new</span> NativeFunction(SSL_get_rfd_ptr,<span class="string">&#x27;int&#x27;</span>,[<span class="string">&#x27;pointer&#x27;</span>]);</span><br></pre></td></tr></table></figure>
<p><img src="https://i.loli.net/2021/11/05/17aphuEcxvCBfFY.png" alt="Jni%E5%B1%82SSL%E6%BA%AF%E6%BA%90%E4%B8%8EHook%2024f8dd39937a490b95ecf5d2d1ced5c0/Untitled%2024.png"></p>

  </div>
  <div class="post-meta">
    <span class="post-time" style="color:#646060;font-size:13px">2021-11-05</span>
  </div>

  <div class="post-footer">
    

    <a href="#top" class="top">返回顶部</a>
  </div>
</article>

<!-- 评论插件 -->

<footer>
  2021
  <span class="author">
    tutucoo
  </span>
</footer>


    </div>
  </body>
</html>