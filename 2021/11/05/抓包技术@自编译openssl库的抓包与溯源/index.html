<!DOCTYPE html>
<html>
  <!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
  
  <title>抓包技术@自编译openssl库的抓包与溯源 - 打渔为生</title>
  <link rel="icon" href="https://i.imgur.com/SrZt9VU.jpg" type="image/x-icon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  
  <meta name="keywords" content=>
  
    <meta name="description" content="全平台漏洞挖掘手记">
  
  
  
    <link rel="alternate" href="/atom.xml " title="打渔为生" type="application/atom+xml">
  

  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.3.0"></head>

  <body>
    <div class="container">
      <header class="header">
  <div class="blog-title">
    <a href="/" class="logo">打渔为生</a>
    <div class="subtitle">tutucoo的技术笔记</div>
  </div>
  <nav class="navbar">
    <ul class="menu">
      
        <li class="menu-item">
          <a href="/" class="menu-item-link">主页</a>
        </li>
      
        <li class="menu-item">
          <a href="/summary" class="menu-item-link">Summary</a>
        </li>
      
        <li class="menu-item">
          <a href="/about" class="menu-item-link">关于</a>
        </li>
      
        <li class="menu-item">
          <a href="/atom.xml" class="menu-item-link">RSS</a>
        </li>
      
    </ul>
  </nav>
</header>

<article class="post">
  <div class="post-title">
    <h1 class="article-title">抓包技术@自编译openssl库的抓包与溯源</h1>
  </div>

  <!-- 文章目录 -->
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%87%AA%E7%BC%96%E8%AF%91openssl%E5%BA%93%E7%9A%84%E6%8A%93%E5%8C%85%E4%B8%8E%E6%BA%AF%E6%BA%90"><span class="toc-text">自编译openssl库的抓包与溯源</span></a></li></ol>

  <div class="post-content">
    <h1 id="自编译openssl库的抓包与溯源"><a href="#自编译openssl库的抓包与溯源" class="headerlink" title="自编译openssl库的抓包与溯源"></a>自编译openssl库的抓包与溯源</h1><p>对于没有抹掉符号的，直接hook SSL_read和SSL_write，SSL_read和SSL_write函数是有特征的，它会调用j_ERR_put_error函数</p>
<p><img src="https://i.loli.net/2021/11/05/sXQkytV9zfEwYoR.png" alt="Untitled"></p>
<p>符号未被抹去时，遍历所有模块，找到SSL_write进行hook，hook代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">Process.enumerateModules().forEach(function (<span class="keyword">module</span>) &#123;</span><br><span class="line">        <span class="keyword">module</span>.enumerateExports().forEach(function (symbol) &#123;</span><br><span class="line">            <span class="keyword">var</span> name = symbol.name;</span><br><span class="line">            <span class="keyword">if</span> (name == <span class="string">&#x27;SSL_read&#x27;</span>) &#123;</span><br><span class="line">                LogPrint(JSON.stringify(<span class="keyword">module</span>) + JSON.stringify(symbol));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (name == <span class="string">&#x27;SSL_write&#x27;</span>) &#123;</span><br><span class="line">                LogPrint(JSON.stringify(<span class="keyword">module</span>) + JSON.stringify(symbol));</span><br><span class="line">                Interceptor.attach(symbol.address, &#123;</span><br><span class="line">                    onEnter: function (args) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.arg0 = args[<span class="number">0</span>];</span><br><span class="line">                        <span class="keyword">this</span>.arg1 = args[<span class="number">1</span>];</span><br><span class="line">                        <span class="keyword">this</span>.arg2 = args[<span class="number">2</span>];</span><br><span class="line">                        LogPrint(<span class="string">&quot;go into &quot;</span> + Process.getCurrentThreadId() + <span class="string">&quot;---&quot;</span> + JSON.stringify(<span class="keyword">module</span>) + <span class="string">&quot;---&quot;</span> + JSON.stringify(symbol));</span><br><span class="line">                        printNativeStack(<span class="keyword">this</span>.context, Process.getCurrentThreadId() + <span class="string">&quot;---&quot;</span> + JSON.stringify(<span class="keyword">module</span>) + <span class="string">&quot;---&quot;</span> + JSON.stringify(symbol));</span><br><span class="line">                        <span class="keyword">var</span> size = ptr(<span class="keyword">this</span>.arg2).toInt32();</span><br><span class="line">                        <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">var</span> sockfd = SSL_get_rfd(<span class="keyword">this</span>.arg0);</span><br><span class="line">                            <span class="keyword">var</span> socketdetail = getsocketdetail(sockfd);</span><br><span class="line">                            console.log(socketdetail + <span class="string">&quot;---&quot;</span> + Process.getCurrentThreadId() + <span class="string">&quot;---&quot;</span> + JSON.stringify(<span class="keyword">module</span>) + <span class="string">&quot;---&quot;</span> + JSON.stringify(symbol) + hexdump(<span class="keyword">this</span>.arg1, &#123;</span><br><span class="line">                                length: size</span><br><span class="line">                            &#125;));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;, onLeave(retval) &#123;</span><br><span class="line">                        LogPrint(<span class="string">&quot;leave &quot;</span> + Process.getCurrentThreadId() + <span class="string">&quot;---&quot;</span> + JSON.stringify(<span class="keyword">module</span>) + <span class="string">&quot;---&quot;</span> + JSON.stringify(symbol));</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>
<p>对于抹掉符号的可以直接hook read和write，然后在调用栈中回溯找到biowrite、SSL_write等函数 ，再定位到未加密前的函数，最后再进行hook</p>
<p>以下是frida提供的打印堆栈信息的接口，Fuzzy模式可以打印出更详细的信息</p>
<p>Fuzzy</p>
<p><img src="https://i.loli.net/2021/11/05/8BEYWsQjybFcK2S.png" alt="Untitled"></p>
<p>ACCURATE</p>
<p><img src="https://i.loli.net/2021/11/05/fSlLDn6cHjzFQo2.png" alt="Untitled"></p>
<p>完整代码 </p>
<figure class="highlight jsx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">LogPrint</span>(<span class="params">log</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> theDate = <span class="keyword">new</span> <span class="built_in">Date</span>();</span><br><span class="line">    <span class="keyword">var</span> hour = theDate.getHours();</span><br><span class="line">    <span class="keyword">var</span> minute = theDate.getMinutes();</span><br><span class="line">    <span class="keyword">var</span> second = theDate.getSeconds();</span><br><span class="line">    <span class="keyword">var</span> mSecond = theDate.getMilliseconds();</span><br><span class="line"></span><br><span class="line">    hour &lt; <span class="number">10</span> ? hour = <span class="string">&quot;0&quot;</span> + hour : hour;</span><br><span class="line">    minute &lt; <span class="number">10</span> ? minute = <span class="string">&quot;0&quot;</span> + minute : minute;</span><br><span class="line">    second &lt; <span class="number">10</span> ? second = <span class="string">&quot;0&quot;</span> + second : second;</span><br><span class="line">    mSecond &lt; <span class="number">10</span> ? mSecond = <span class="string">&quot;00&quot;</span> + mSecond : mSecond &lt; <span class="number">100</span> ? mSecond = <span class="string">&quot;0&quot;</span> + mSecond : mSecond;</span><br><span class="line">    <span class="keyword">var</span> time = hour + <span class="string">&quot;:&quot;</span> + minute + <span class="string">&quot;:&quot;</span> + second + <span class="string">&quot;:&quot;</span> + mSecond;</span><br><span class="line">    <span class="keyword">var</span> threadid = Process.getCurrentThreadId();</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">&quot;[&quot;</span> + time + <span class="string">&quot;]&quot;</span> + <span class="string">&quot;-&gt;threadid:&quot;</span> + threadid + <span class="string">&quot;--&quot;</span> + log);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printNativeStack</span>(<span class="params">context, name</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> trace = Thread.backtrace(context, Backtracer.FUZZY).map(DebugSymbol.fromAddress).join(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">    LogPrint(<span class="string">&quot;-----------start:&quot;</span> + name + <span class="string">&quot;--------------&quot;</span>);</span><br><span class="line">    LogPrint(trace);</span><br><span class="line">    LogPrint(<span class="string">&quot;-----------end:&quot;</span> + name + <span class="string">&quot;--------------&quot;</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">printJavaStack</span>(<span class="params">name</span>) </span>&#123;</span><br><span class="line">    Java.perform(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> Exception = Java.use(<span class="string">&quot;java.lang.Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> ins = Exception.$new(<span class="string">&quot;Exception&quot;</span>);</span><br><span class="line">        <span class="keyword">var</span> straces = ins.getStackTrace();</span><br><span class="line">        <span class="keyword">if</span> (straces != <span class="literal">undefined</span> &amp;&amp; straces != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> strace = straces.toString();</span><br><span class="line">            <span class="keyword">var</span> replaceStr = strace.replace(<span class="regexp">/,/g</span>, <span class="string">&quot; \n &quot;</span>);</span><br><span class="line">            LogPrint(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack strat=======================&quot;</span>);</span><br><span class="line">            LogPrint(replaceStr);</span><br><span class="line">            LogPrint(<span class="string">&quot;=============================&quot;</span> + name + <span class="string">&quot; Stack end======================= \n &quot;</span>);</span><br><span class="line">            Exception.$dispose();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isprintable</span>(<span class="params">value</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (value &gt;= <span class="number">32</span> &amp;&amp; value &lt;= <span class="number">126</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getsocketdetail</span>(<span class="params">fd</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">var</span> type = Socket.type(fd);</span><br><span class="line">    <span class="keyword">if</span> (type != <span class="literal">null</span>) &#123;</span><br><span class="line">        result = result + <span class="string">&quot;type:&quot;</span> + type;</span><br><span class="line">        <span class="keyword">var</span> peer = Socket.peerAddress(fd);</span><br><span class="line">        <span class="keyword">var</span> local = Socket.localAddress(fd);</span><br><span class="line">        result = result + <span class="string">&quot;,address:&quot;</span> + <span class="built_in">JSON</span>.stringify(peer) + <span class="string">&quot;,local:&quot;</span> + <span class="built_in">JSON</span>.stringify(local);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = <span class="string">&quot;unknown&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getip</span>(<span class="params">ip_ptr</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = ptr(ip_ptr).readU8() + <span class="string">&quot;.&quot;</span> + ptr(ip_ptr.add(<span class="number">1</span>)).readU8() + <span class="string">&quot;.&quot;</span> + ptr(ip_ptr.add(<span class="number">2</span>)).readU8() + <span class="string">&quot;.&quot;</span> + ptr(ip_ptr.add(<span class="number">3</span>)).readU8()</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hooklibc</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> libcmodule = Process.getModuleByName(<span class="string">&quot;libc.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> read_addr = libcmodule.getExportByName(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> write_addr = libcmodule.getExportByName(<span class="string">&quot;write&quot;</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(read_addr + <span class="string">&quot;---&quot;</span> + write_addr);</span><br><span class="line">    Interceptor.attach(read_addr, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.arg0 = args[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg1 = args[<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg2 = args[<span class="number">2</span>];</span><br><span class="line">            <span class="built_in">this</span>.socketinfo = getsocketdetail(<span class="built_in">this</span>.arg0.toInt32());</span><br><span class="line">            LogPrint(<span class="string">&quot;go into libc.so-&gt;read_addr&quot;</span> + <span class="string">&quot;---&quot;</span> + <span class="built_in">this</span>.socketinfo);</span><br><span class="line">            <span class="built_in">this</span>.flag = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.socketinfo.indexOf(<span class="string">&quot;tcp&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.flag = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.flag) &#123;</span><br><span class="line">                printNativeStack(<span class="built_in">this</span>.context, Process.getCurrentThreadId() + <span class="string">&quot;read&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;, <span class="function"><span class="title">onLeave</span>(<span class="params">retval</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.flag) &#123;</span><br><span class="line">                <span class="keyword">var</span> size = retval.toInt32();</span><br><span class="line">                <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(Process.getCurrentThreadId() + <span class="string">&quot;---libc.so-&gt;read:&quot;</span> + hexdump(<span class="built_in">this</span>.arg1, &#123;</span><br><span class="line">                        length: size</span><br><span class="line">                    &#125;));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            LogPrint(<span class="string">&quot;leave libc.so-&gt;read&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    Interceptor.attach(write_addr, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.arg0 = args[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg1 = args[<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg2 = args[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">            <span class="built_in">this</span>.socketinfo = getsocketdetail(<span class="built_in">this</span>.arg0.toInt32());</span><br><span class="line">            LogPrint(<span class="string">&quot;go into libc.so-&gt;write&quot;</span> + <span class="string">&quot;---&quot;</span> + <span class="built_in">this</span>.socketinfo);</span><br><span class="line">            <span class="built_in">this</span>.flag = <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.socketinfo.indexOf(<span class="string">&quot;tcp&quot;</span>) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="built_in">this</span>.flag = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">this</span>.flag) &#123;</span><br><span class="line">                printNativeStack(<span class="built_in">this</span>.context, Process.getCurrentThreadId() + <span class="string">&quot;write&quot;</span>);</span><br><span class="line">                <span class="keyword">var</span> size = ptr(<span class="built_in">this</span>.arg2).toInt32();</span><br><span class="line">                <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(Process.getCurrentThreadId() + <span class="string">&quot;---libc.so-&gt;write:&quot;</span> + hexdump(<span class="built_in">this</span>.arg1, &#123;</span><br><span class="line">                        length: size</span><br><span class="line">                    &#125;));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;, <span class="function"><span class="title">onLeave</span>(<span class="params">retval</span>)</span> &#123;</span><br><span class="line">            LogPrint(<span class="string">&quot;leave libc.so-&gt;write&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookssl</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//SSL_get_rfd</span></span><br><span class="line">    <span class="comment">//int SSL_get_rfd(const SSL *ssl)</span></span><br><span class="line">    <span class="keyword">var</span> libsslmodule = Process.getModuleByName(<span class="string">&quot;libssl.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> read_addr = libsslmodule.getExportByName(<span class="string">&quot;SSL_read&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> write_addr = libsslmodule.getExportByName(<span class="string">&quot;SSL_write&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> bioread_addr = libsslmodule.getExportByName(<span class="string">&quot;BIO_read&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> biowrite_addr = libsslmodule.getExportByName(<span class="string">&quot;BIO_write&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> SSL_get_rfd_ptr = libsslmodule.getExportByName(<span class="string">&#x27;SSL_get_rfd&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> SSL_get_rfd = <span class="keyword">new</span> NativeFunction(SSL_get_rfd_ptr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line">    Interceptor.attach(read_addr, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.arg0 = args[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg1 = args[<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg2 = args[<span class="number">2</span>];</span><br><span class="line">            LogPrint(<span class="string">&quot;go into libssl.so-&gt;SSL_read&quot;</span>);</span><br><span class="line">            printNativeStack(<span class="built_in">this</span>.context, Process.getCurrentThreadId() + <span class="string">&quot;SSL_read&quot;</span>);</span><br><span class="line">        &#125;, <span class="function"><span class="title">onLeave</span>(<span class="params">retval</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> size = retval.toInt32();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> sockfd = SSL_get_rfd(<span class="built_in">this</span>.arg0);</span><br><span class="line">                <span class="keyword">var</span> socketdetail = getsocketdetail(sockfd);</span><br><span class="line">                <span class="built_in">console</span>.log(socketdetail + <span class="string">&quot;---&quot;</span> + Process.getCurrentThreadId() + <span class="string">&quot;---libssl.so-&gt;SSL_read:&quot;</span> + hexdump(<span class="built_in">this</span>.arg1, &#123;</span><br><span class="line">                    length: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line">            LogPrint(<span class="string">&quot;leave libssl.so-&gt;SSL_read&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    Interceptor.attach(write_addr, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.arg0 = args[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg1 = args[<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg2 = args[<span class="number">2</span>];</span><br><span class="line">            LogPrint(<span class="string">&quot;go into libssl.so-&gt;SSL_write&quot;</span>);</span><br><span class="line">            printNativeStack(<span class="built_in">this</span>.context, Process.getCurrentThreadId() + <span class="string">&quot;SSL_write&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> size = ptr(<span class="built_in">this</span>.arg2).toInt32();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> sockfd = SSL_get_rfd(<span class="built_in">this</span>.arg0);</span><br><span class="line">                <span class="keyword">var</span> socketdetail = getsocketdetail(sockfd);</span><br><span class="line">                <span class="built_in">console</span>.log(socketdetail + <span class="string">&quot;---&quot;</span> + Process.getCurrentThreadId() + <span class="string">&quot;---libssl.so-&gt;SSL_write:&quot;</span> + hexdump(<span class="built_in">this</span>.arg1, &#123;</span><br><span class="line">                    length: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="function"><span class="title">onLeave</span>(<span class="params">retval</span>)</span> &#123;</span><br><span class="line">            LogPrint(<span class="string">&quot;leave libssl.so-&gt;SSL_write&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    Interceptor.attach(bioread_addr, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.arg0 = args[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg1 = args[<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg2 = args[<span class="number">2</span>];</span><br><span class="line">            LogPrint(<span class="string">&quot;go into libssl.so-&gt;bioread_addr&quot;</span>);</span><br><span class="line">            printNativeStack(<span class="built_in">this</span>.context, Process.getCurrentThreadId() + <span class="string">&quot;bioread_addr&quot;</span>);</span><br><span class="line">        &#125;, <span class="function"><span class="title">onLeave</span>(<span class="params">retval</span>)</span> &#123;</span><br><span class="line">            <span class="keyword">var</span> size = retval.toInt32();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> sockfd = SSL_get_rfd(<span class="built_in">this</span>.arg0);</span><br><span class="line">                <span class="keyword">var</span> socketdetail = getsocketdetail(sockfd);</span><br><span class="line">                <span class="built_in">console</span>.log(socketdetail + <span class="string">&quot;---&quot;</span> + Process.getCurrentThreadId() + <span class="string">&quot;---libssl.so-&gt;bioread_addr:&quot;</span> + hexdump(<span class="built_in">this</span>.arg1, &#123;</span><br><span class="line">                    length: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line">            LogPrint(<span class="string">&quot;leave libssl.so-&gt;bioread_addr&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    Interceptor.attach(biowrite_addr, &#123;</span><br><span class="line">        onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.arg0 = args[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg1 = args[<span class="number">1</span>];</span><br><span class="line">            <span class="built_in">this</span>.arg2 = args[<span class="number">2</span>];</span><br><span class="line">            LogPrint(<span class="string">&quot;go into libssl.so-&gt;biowrite_addr&quot;</span>);</span><br><span class="line">            printNativeStack(<span class="built_in">this</span>.context, Process.getCurrentThreadId() + <span class="string">&quot;biowrite_addr&quot;</span>);</span><br><span class="line">            <span class="keyword">var</span> size = ptr(<span class="built_in">this</span>.arg2).toInt32();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">var</span> sockfd = SSL_get_rfd(<span class="built_in">this</span>.arg0);</span><br><span class="line">                <span class="keyword">var</span> socketdetail = getsocketdetail(sockfd);</span><br><span class="line">                <span class="built_in">console</span>.log(socketdetail + <span class="string">&quot;---&quot;</span> + Process.getCurrentThreadId() + <span class="string">&quot;---libssl.so-&gt;biowrite_addr:&quot;</span> + hexdump(<span class="built_in">this</span>.arg1, &#123;</span><br><span class="line">                    length: size</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="function"><span class="title">onLeave</span>(<span class="params">retval</span>)</span> &#123;</span><br><span class="line"></span><br><span class="line">            LogPrint(<span class="string">&quot;leave libssl.so-&gt;biowrite_addr&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hookallssl</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> libsslmodule = Process.getModuleByName(<span class="string">&quot;libssl.so&quot;</span>);</span><br><span class="line">    <span class="keyword">var</span> SSL_get_rfd_ptr = libsslmodule.getExportByName(<span class="string">&#x27;SSL_get_rfd&#x27;</span>);</span><br><span class="line">    <span class="keyword">var</span> SSL_get_rfd = <span class="keyword">new</span> NativeFunction(SSL_get_rfd_ptr, <span class="string">&#x27;int&#x27;</span>, [<span class="string">&#x27;pointer&#x27;</span>]);</span><br><span class="line">    <span class="comment">//遍历所有so模块</span></span><br><span class="line">    Process.enumerateModules().forEach(<span class="function"><span class="keyword">function</span> (<span class="params"><span class="built_in">module</span></span>) </span>&#123;</span><br><span class="line">        <span class="comment">//遍历所有符号,找到SSL_read或SSL_write后进行hook</span></span><br><span class="line">        <span class="built_in">module</span>.enumerateExports().forEach(<span class="function"><span class="keyword">function</span> (<span class="params">symbol</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">var</span> name = symbol.name;</span><br><span class="line">            <span class="keyword">if</span> (name == <span class="string">&#x27;SSL_read&#x27;</span>) &#123;</span><br><span class="line">                LogPrint(<span class="built_in">JSON</span>.stringify(<span class="built_in">module</span>) + <span class="built_in">JSON</span>.stringify(symbol));</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (name == <span class="string">&#x27;SSL_write&#x27;</span>) &#123;</span><br><span class="line">                LogPrint(<span class="built_in">JSON</span>.stringify(<span class="built_in">module</span>) + <span class="built_in">JSON</span>.stringify(symbol));</span><br><span class="line">                Interceptor.attach(symbol.address, &#123;</span><br><span class="line">                    onEnter: <span class="function"><span class="keyword">function</span> (<span class="params">args</span>) </span>&#123;</span><br><span class="line">                        <span class="built_in">this</span>.arg0 = args[<span class="number">0</span>];</span><br><span class="line">                        <span class="built_in">this</span>.arg1 = args[<span class="number">1</span>];</span><br><span class="line">                        <span class="built_in">this</span>.arg2 = args[<span class="number">2</span>];</span><br><span class="line">                        LogPrint(<span class="string">&quot;go into &quot;</span> + Process.getCurrentThreadId() + <span class="string">&quot;---&quot;</span> + <span class="built_in">JSON</span>.stringify(<span class="built_in">module</span>) + <span class="string">&quot;---&quot;</span> + <span class="built_in">JSON</span>.stringify(symbol));</span><br><span class="line">                        printNativeStack(<span class="built_in">this</span>.context, Process.getCurrentThreadId() + <span class="string">&quot;---&quot;</span> + <span class="built_in">JSON</span>.stringify(<span class="built_in">module</span>) + <span class="string">&quot;---&quot;</span> + <span class="built_in">JSON</span>.stringify(symbol));</span><br><span class="line">                        <span class="keyword">var</span> size = ptr(<span class="built_in">this</span>.arg2).toInt32();</span><br><span class="line">                        <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                            <span class="keyword">var</span> sockfd = SSL_get_rfd(<span class="built_in">this</span>.arg0);</span><br><span class="line">                            <span class="keyword">var</span> socketdetail = getsocketdetail(sockfd);</span><br><span class="line">                            <span class="built_in">console</span>.log(socketdetail + <span class="string">&quot;---&quot;</span> + Process.getCurrentThreadId() + <span class="string">&quot;---&quot;</span> + <span class="built_in">JSON</span>.stringify(<span class="built_in">module</span>) + <span class="string">&quot;---&quot;</span> + <span class="built_in">JSON</span>.stringify(symbol) + hexdump(<span class="built_in">this</span>.arg1, &#123;</span><br><span class="line">                                length: size</span><br><span class="line">                            &#125;));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;, <span class="function"><span class="title">onLeave</span>(<span class="params">retval</span>)</span> &#123;</span><br><span class="line">                        LogPrint(<span class="string">&quot;leave &quot;</span> + Process.getCurrentThreadId() + <span class="string">&quot;---&quot;</span> + <span class="built_in">JSON</span>.stringify(<span class="built_in">module</span>) + <span class="string">&quot;---&quot;</span> + <span class="built_in">JSON</span>.stringify(symbol));</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">main</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">//对于抹掉符号的用这个函数</span></span><br><span class="line">    <span class="comment">//hooklibc();</span></span><br><span class="line">    hookssl();</span><br><span class="line">    <span class="comment">//自编译openssl,函数符号还在的情况用这个函数</span></span><br><span class="line">    <span class="comment">//hookallssl();</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setImmediate(main);</span><br></pre></td></tr></table></figure>
  </div>
  <div class="post-meta">
    <span class="post-time" style="color:#646060;font-size:13px">2021-11-05</span>
  </div>

  <div class="post-footer">
    

    <a href="#top" class="top">返回顶部</a>
  </div>
</article>

<!-- 评论插件 -->

<footer>
  2021
  <span class="author">
    tutucoo
  </span>
</footer>


    </div>
  </body>
</html>